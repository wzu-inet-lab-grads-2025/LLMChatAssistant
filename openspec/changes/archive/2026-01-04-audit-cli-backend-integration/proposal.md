# CLI 前后端集成审计提案

## 变更信息

- **变更ID**: audit-cli-backend-integration
- **类型**: 审计（Audit）
- **创建日期**: 2026-01-03
- **状态**: 草案

## 背景

基于最近的测试修复工作（测试通过率从 81.05% 提升到 94.77%），我们发现并修复了多个后端实现问题：

1. **会话历史管理** - session_id 冲突导致多会话数据混淆
2. **文件下载工具** - 路径验证和目录类型检查缺失
3. **命令执行工具** - 参数验证逻辑不完善
4. **Agent 响应循环** - conversation_history 自动更新缺失

虽然后端功能已经通过集成测试验证，但还需要确认：

- **CLI 前端是否能正确调用后端功能**
- **消息编码/解码是否正确**
- **文件上传/下载流程是否完整**
- **错误处理是否有效**

## 目标

### 主要目标

审计 CLI 客户端（`clients/cli/`）与后端服务器（`server/`）的集成，确保：

1. ✅ **消息通信** - NPLT 协议消息编码/解码正确
2. ✅ **文件上传** - RDT 协议上传功能完整且可靠
3. ✅ **文件下载** - 文件下载提议和传输流程正确
4. ✅ **工具调用** - Agent 工具调用能正确触发和返回结果
5. ✅ **错误处理** - 网络错误、协议错误、业务错误能正确处理
6. ✅ **会话管理** - 多会话创建、切换、删除功能正常

### 非目标

- 不修改后端实现（已通过测试验证）
- 不添加新功能
- 不涉及 Web 前端

## 范围

### 包含的功能

1. **NPLT 协议通信**
   - 消息类型：CHAT_TEXT, AGENT_THOUGHT, DOWNLOAD_OFFER, FILE_METADATA 等
   - 编码/解码正确性
   - 序列号管理

2. **文件上传流程**
   - 客户端发起上传请求
   - 服务器接收文件并保存
   - 错误处理（文件过大、格式不支持等）

3. **文件下载流程**
   - Agent 触发文件下载工具
   - 服务器发送下载提议
   - 客户端接收并下载文件
   - RDT/HTTP 降级机制

4. **会话管理**
   - 创建新会话
   - 列出会话
   - 切换会话
   - 删除会话
   - 会话历史加载

5. **错误处理**
   - 网络中断和重连
   - 协议错误
   - 服务器错误响应

### 不包含的功能

- HTTP 服务器集成
- WebSocket 通信
- Web UI 功能
- 性能测试（已在 performance test 中覆盖）

## 相关变更

此提案独立于其他变更，但依赖于：

- `audit-backend-functions` - 后端功能审计（已归档）
- `fix-cli-user-input-display` - CLI UI 修复（已归档）

## 风险与依赖

### 风险

- **测试覆盖不足** - 可能遗漏某些边缘情况
- **协议不匹配** - 客户端和服务器的协议版本可能不一致

### 依赖

- 后端服务器必须正常运行
- 测试数据文件必须可用
- 网络连接必须稳定

## 验收标准

1. 所有 NPLT 消息类型能正确编码和解码
2. 文件上传/下载在所有测试场景中成功
3. 会话管理功能无错误
4. 错误场景能正确处理并显示有意义的错误信息
5. 所有端到端测试通过

## 时间估算

- 准备阶段：0.5 天（熟悉代码）
- 审计阶段：1 天（执行审计）
- 报告阶段：0.5 天（编写报告）
- **总计**：约 2 天
