# CLI 前后端集成审计任务

## 任务概览

本变更包含 4 个主要任务，按优先级排序：

1. **协议层审计** - 验证 NPLT/RDT 协议实现
2. **消息通信审计** - 验证消息编码/解码和传输
3. **文件传输审计** - 验证上传/下载功能
4. **会话管理审计** - 验证会话操作

---

## 任务 1：协议层审计

**优先级**: P0（必须）
**预计时间**: 2-3 小时
**依赖**: 无

### 验证项

- [ ] **1.1 NPLT 协议版本一致性**
  - 检查 `shared/protocols/nplt.py` 在客户端和服务器端是否一致
  - 验证 `PROTOCOL_VERSION` 常量匹配
  - 验证 `MessageType` 枚举值一致

- [ ] **1.2 RDT 协议版本一致性**
  - 检查 `shared/protocols/rdt.py` 在客户端和服务器端是否一致
  - 验证 `PROTOCOL_VERSION` 常量匹配
  - 验证 `RDTPacket` 数据结构一致

- [ ] **1.3 消息格式定义**
  - 验证 NPLT 消息头格式：`>BHH` (uint8, uint16, uint16)
  - 验证 RDT 包头格式：`>HH` (uint16, uint16)
  - 验证最大数据长度限制一致

- [ ] **1.4 编码/解码函数**
  - 验证 `NPLTMessage.encode()` 和 `NPLTMessage.decode()` 正确
  - 验证 `RDTPacket.encode()` 和 `RDTPacket.decode()` 正确
  - 检查字节序（大端/小端）一致性

**验证方法**:
- 代码审查（对比客户端和服务器端的协议文件）
- 单元测试验证（如果有协议测试）

---

## 任务 2：消息通信审计

**优先级**: P0（必须）
**预计时间**: 3-4 小时
**依赖**: 任务 1

### 验证项

- [ ] **2.1 消息发送**
  - 客户端能正确编码并发送所有 NPLT 消息类型
  - 验证 `NPLTClient.send_message()` 实现
  - 验证序列号递增正确

- [ ] **2.2 消息接收**
  - 客户端能正确接收并解码服务器消息
  - 验证 `NPLTClient.receive_message()` 实现
  - 验证序列号检查正确

- [ ] **2.3 消息类型处理**
  - 验证每种消息类型有对应的处理器
  - 检查 `DOWNLOAD_OFFER` 消息处理
  - 检查 `AGENT_THOUGHT` 消息处理
  - 检查 `CHAT_TEXT` 消息处理

- [ ] **2.4 错误处理**
  - 验证网络错误时能正确重连
  - 验证协议错误时能显示错误信息
  - 检查超时处理逻辑

**验证方法**:
- 运行现有的 E2E 测试：`test_connection.py`, `test_chat.py`
- 代码审查客户端消息处理逻辑
- 添加调试日志验证消息流

---

## 任务 3：文件传输审计

**优先级**: P0（必须）
**预计时间**: 4-5 小时
**依赖**: 任务 1, 任务 2

### 验证项

- [ ] **3.1 文件上传**
  - 验证客户端能发起文件上传请求
  - 验证 RDT 客户端能发送文件元数据
  - 验证 RDT 客户端能分块发送文件数据
  - 检查文件完整性（MD5/SHA256 校验）

- [ ] **3.2 文件下载**
  - 验证客户端能接收 `DOWNLOAD_OFFER` 消息
  - 验证客户端能选择 RDT 或 HTTP 下载
  - 验证 RDT 下载能正确接收文件
  - 检查文件保存到正确位置

- [ ] **3.3 文件大小限制**
  - 验证小文件（< 1MB）上传下载成功
  - 验证中等文件（1-5MB）上传下载成功
  - 验证大文件（5-10MB）上传下载成功
  - 检查超大文件（> 10MB）的错误处理

- [ ] **3.4 错误处理**
  - 验证文件不存在时的错误处理
  - 验证权限不足时的错误处理
  - 验证网络中断时的恢复
  - 检查磁盘空间不足的处理

**验证方法**:
- 运行文件上传测试：`clients/cli/tests/e2e/test_file_upload.py`
- 运行文件下载测试：`clients/cli/tests/e2e/test_file_download.py`
- 运行边界测试：`clients/cli/tests/boundary/test_large_files.py`
- 验证文件完整性校验

---

## 任务 4：会话管理审计

**优先级**: P1（重要）
**预计时间**: 2-3 小时
**依赖**: 任务 2

### 验证项

- [ ] **4.1 创建会话**
  - 验证客户端能发送 `SESSION_NEW` 消息
  - 验证服务器能创建新会话并返回 session_id
  - 检查 session_id 格式正确

- [ ] **4.2 列出会话**
  - 验证客户端能发送 `SESSION_LIST` 消息
  - 验证服务器能返回所有会话列表
  - 检查会话信息完整（name, message_count, last_accessed）

- [ ] **4.3 切换会话**
  - 验证客户端能发送 `SESSION_SWITCH` 消息
  - 验证服务器能切换到指定会话
  - 检查切换后消息历史正确加载

- [ ] **4.4 删除会话**
  - 验证客户端能发送 `SESSION_DELETE` 消息
  - 验证服务器能删除指定会话
  - 检查不能删除当前活动会话

- [ ] **4.5 错误处理**
  - 验证切换到不存在的会话时的错误
  - 验证删除不存在的会话时的错误
  - 检查会话 ID 格式错误的处理

**验证方法**:
- 运行会话管理测试：`clients/cli/tests/e2e/test_session_management.py`
- 代码审查会话管理逻辑
- 手动测试各种会话操作

---

## 任务完成标准

所有任务满足以下条件即为完成：

1. ✅ 所有验证项都已检查
2. ✅ 发现的问题已记录
3. ✅ 测试结果已汇总成报告
4. ✅ 报告包含：
   - 通过/失败的功能列表
   - 发现的问题清单
   - 建议的修复方案（如有必要）

---

## 并行化机会

- **任务 1** 可以独立进行
- **任务 2** 依赖于任务 1
- **任务 3** 可以与任务 4 并行（都依赖任务 1 和 2）

建议执行顺序：1 → (2, 3, 4 并行)
