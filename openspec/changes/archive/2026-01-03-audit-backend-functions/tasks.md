# 实施任务清单

**注意**: 本提案规模巨大(需要460+测试用例),当前已完成核心测试基础设施和最重要的Agent测试。

## 0. 准备阶段 ✅
- [x] 0.1 审阅当前后端代码实现（agent.py, tools/*.py, llm/zhipu.py, main.py）
- [x] 0.2 删除tests/目录下的所有老旧测试文件（已删除27个文件）
- [x] 0.3 设计新的测试架构（单元测试、集成测试、端到端测试）
- [x] 0.4 准备测试环境和测试数据（配置文件、测试文件、测试用例）

## 1. 实施测试套件

### 1.1 基础设施和测试工具 ✅
- [x] 1.1.1 创建测试配置管理模块（tests/fixtures/conftest.py）
  - pytest fixtures配置
  - 智谱API真实调用（无需Mock）
  - 测试数据准备（配置文件、日志文件、文档）
  - 测试环境配置

- [x] 1.1.2 创建测试辅助工具（tests/helpers/）
  - 测试报告生成器（report.py） - 支持Markdown和JSON双格式
  - 运行脚本（run_agent_tests.py）
  - 待实现: NPLT协议消息构造和解析、模拟客户端

### 1.2 ReAct Agent核心功能测试
- [ ] 1.2.1 创建agent核心测试（tests/integration/test_agent_core.py）
  - 测试简单对话（5+样例）
  - 测试单工具调用（5+样例）
  - 测试多工具串行调用（5+样例）
  - 测试工具调用失败处理（5+样例）
  - 测试流式输出正确性（5+样例）
  - 测试ReAct循环（最多5轮）

### 1.3 Agent意图识别和多工具协作测试（重点）✅ 部分完成
- [x] 1.3.1 创建意图识别测试（tests/integration/test_agent_intent.py）
  - ✅ 场景A：自然语言命令 → command_executor（5个样例）
  - ✅ 场景B：直接命令 → command_executor（5个样例）
  - ✅ 场景C：命令询问 → 直接聊天（5个样例）
  - ✅ 场景D：系统状态查询 → sys_monitor（5个样例）
  - ✅ 场景E：文件检索 → semantic_search（5个样例）
  - **总计**: 25个测试用例已创建

- [x] 1.3.2 创建多工具协作测试（tests/integration/test_agent_multi_tool.py）
  - ✅ "查看配置文件内容"（1个场景测试）
  - ✅ "搜索日志中的错误"（1个场景测试）
  - ✅ "数据库配置是什么"（1个场景测试）
  - ✅ "查看项目的README文档"（1个场景测试）
  - ✅ "检查日志文件是否有异常"（1个场景测试）
  - **总计**: 5个复杂场景测试已创建
  - **待补充**: 每个场景增加参数化变体（目前每个场景只有1个测试）

### 1.4 工具链测试
- [ ] 1.4.1 测试command_executor工具（tests/integration/test_tool_command.py）
  - ls命令（5+样例：不同参数组合）
  - cat命令（5+样例：不同文件）
  - grep命令（5+样例：不同搜索模式）
  - head/tail命令（5+样例：不同行数）
  - ps/pwd/whoami/df/free命令（各5+样例）
  - 测试白名单和黑名单验证（5+样例）
  - 测试路径白名单验证（5+样例）
  - 测试参数验证（5+样例）
  - 测试超时处理（5+样例）

- [ ] 1.4.2 测试sys_monitor工具（tests/integration/test_tool_monitor.py）
  - CPU监控（5+样例）
  - 内存监控（5+样例）
  - 磁盘监控（5+样例）
  - 综合监控all（5+样例）

- [ ] 1.4.3 测试semantic_search工具（tests/integration/test_tool_semantic_search.py）
  - 精确文件名匹配（5+样例）
  - 模糊文件名匹配（5+样例）
  - 语义检索（5+样例）
  - 混合检索策略（5+样例：包含多层检索）
  - scope参数测试（all/system/uploads，各5+样例）
  - 测试索引文件不存在的情况（5+样例）

- [ ] 1.4.4 测试file_upload工具（tests/integration/test_tool_file_upload.py）
  - 列出所有文件（5+样例）
  - 代词引用：this/these/previous（各5+样例）
  - 按文件类型过滤（5+样例）
  - 测试空文件列表（5+样例）

- [ ] 1.4.5 测试file_download工具（tests/integration/test_tool_file_download.py）
  - 准备下载已索引文件（5+样例）
  - 准备下载用户上传文件（5+样例）
  - 测试文件路径验证（5+样例）
  - 测试RDT下载提议生成（5+样例）

### 1.5 后端与前端通信测试
- [ ] 1.5.1 创建通信协议测试（tests/integration/test_nplt_protocol.py）
  - 测试NPLT消息编码/解码（5+样例：不同消息类型）
  - 测试流式输出分块传输（5+样例：不同chunk大小）
  - 测试状态通知消息（5+样例：thinking/tool_call/generating）
  - 测试心跳消息（5+样例）
  - 测试错误消息传递（5+样例）
  - 测试文件上传消息（FILE_METADATA + FILE_DATA，5+样例）
  - 测试文件下载提议消息（DOWNLOAD_OFFER，5+样例）
  - 测试会话管理消息（SESSION_LIST/SWITCH/NEW/DELETE，各5+样例）

- [ ] 1.5.2 创建端到端通信测试（tests/integration/test_client_server_comm.py）
  - 模拟客户端连接服务器（5+样例）
  - 模拟客户端发送消息并接收响应（5+样例）
  - 测试多客户端并发连接（5+样例）
  - 测试连接超时和重连（5+样例）

### 1.6 历史聊天记录持久化测试
- [ ] 1.6.1 创建历史持久化测试（tests/integration/test_history_persistence.py）
  - 测试对话历史保存到磁盘（5+样例：不同对话长度）
  - 测试会话恢复后历史加载（5+样例）
  - 测试工具调用记录保存（5+样例：不同工具组合）
  - 测试多会话历史隔离（5+样例：不同会话数量）
  - 测试历史记录格式验证（5+样例：检查所有字段）
  - 测试历史记录的增删改查（5+样例）
  - 测试历史文件损坏恢复（5+样例）

### 1.7 文件上传、存储、索引测试
- [ ] 1.7.1 创建文件处理测试（tests/integration/test_file_lifecycle.py）
  - 测试文件上传到正确路径（5+样例：不同文件大小）
  - 测试文件元数据保存（5+样例：不同文件类型）
  - 测试白名单文件自动索引（5+样例：不同白名单路径）
  - 测试文件向量化和存储（5+样例：不同文件内容）
  - 测试文件与session.uploaded_files关联（5+样例）
  - 测试大文件分块上传（5+样例：不同块大小）
  - 测试非白名单文件不索引（5+样例）

### 1.8 上下文管理测试
- [ ] 1.8.1 创建上下文管理测试（tests/integration/test_context_management.py）
  - 测试对话历史传递给LLM（5+样例：不同历史长度）
  - 测试上下文窗口限制（5+样例：不同max_turns）
  - 测试系统提示词注入（5+样例：不同系统提示）
  - 测试工具调用结果加入上下文（5+样例：不同工具）
  - 测试多轮对话上下文连贯性（5+样例：不同轮数）

### 1.9 上传文件后的上下文管理测试
- [ ] 1.9.1 创建文件上下文测试（tests/integration/test_file_context.py）
  - 测试uploaded_files通过session传递（5+样例）
  - 测试文件代词引用解析（5+样例：this/these/previous）
  - 测试文件路径在工具中的使用（5+样例：不同工具）
  - 测试上传文件后的语义检索（5+样例）
  - 测试文件引用跨对话持久化（5+样例）

### 1.10 聊天功能测试
- [ ] 1.10.1 创建聊天功能测试（tests/integration/test_chat_features.py）
  - 测试正常对话流程（5+样例）
  - 测试流式输出实时性（5+样例：不同响应长度）
  - 测试会话创建（5+样例）
  - 测试会话切换（5+样例：不同会话数）
  - 测试会话删除（5+样例）
  - 测试会话列表（5+样例：不同会话数量）
  - 测试自动命名（5+样例：不同对话内容）
  - 测试会话消息计数（5+样例）

### 1.11 错误处理测试
- [ ] 1.11.1 创建错误处理测试（tests/integration/test_error_handling.py）
  - 测试API调用失败降级（5+样例：不同失败原因）
  - 测试工具执行超时（5+样例：不同超时时间）
  - 测试参数验证失败（5+样例：不同验证错误）
  - 测试网络连接问题（5+样例：不同网络问题）
  - 测试文件访问权限问题（5+样例：不同权限错误）
  - 测试命令执行失败（5+样例：不同失败场景）
  - 测试工具不存在错误（5+样例）

### 1.12 性能测试
- [ ] 1.12.1 创建性能测试（tests/performance/test_performance.py）
  - 测试响应时间（5+样例：不同复杂度）
  - 测试并发处理能力（5+样例：不同并发数）
  - 测试内存使用（5+样例：不同场景）
  - 测试流式输出延迟（5+样例）

## 2. 生成测试报告

### 2.1 收集测试结果
- [ ] 2.1.1 运行所有测试并收集原始数据
- [ ] 2.1.2 记录每个测试样例的详细信息（输入、工具调用、输出）
- [ ] 2.1.3 统计通过率、失败率、问题数量

### 2.2 生成详细报告
- [ ] 2.2.1 生成执行摘要
  - 总体测试统计（总样例数、通过、失败、部分通过）
  - 按测试类别的统计
  - 关键指标（意图识别准确率、多工具协作成功率）

- [ ] 2.2.2 生成每个测试样例的详细记录
  - 测试输入
  - 预期行为
  - 实际工具链调用情况（多轮）
  - 传递给前端的消息序列
  - 历史记录存储
  - 测试结果
  - 问题/备注

- [ ] 2.2.3 生成问题清单
  - 按严重程度分级（严重/中等/轻微）
  - 问题描述
  - 复现步骤
  - 实际行为 vs 预期行为

- [ ] 2.2.4 生成改进建议
  - 问题修复优先级
  - 代码改进建议
  - 测试覆盖率提升建议

### 2.3 报告格式化
- [ ] 2.3.1 生成Markdown格式测试报告（docs/test_report.md）
- [ ] 2.3.2 生成JSON格式测试数据（用于后续分析）
- [ ] 2.3.3 生成测试覆盖率报告（HTML格式）

## 3. 验收标准
- [ ] 3.1 所有测试样例至少执行一次
- [ ] 3.2 测试报告包含所有必需信息
- [ ] 3.3 意图识别准确率 ≥ 80%
- [ ] 3.4 多工具协作成功率 ≥ 70%
- [ ] 3.5 测试覆盖率 ≥ 70%
- [ ] 3.6 所有发现的问题都有详细记录

## 4. 清理和归档
- [ ] 4.1 清理测试过程中产生的临时数据
- [ ] 4.2 归档测试代码和数据
- [ ] 4.3 更新项目文档（如果有必要）
