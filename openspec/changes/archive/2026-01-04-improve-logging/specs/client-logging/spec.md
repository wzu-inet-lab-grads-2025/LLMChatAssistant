# 客户端日志增强规范

## 新增需求

### 需求：客户端关键操作日志记录

客户端**必须**在 `client.log` 中记录所有关键操作，包括启动、关闭、用户输入、命令执行、网络连接、消息收发、心跳、流式输出、文件下载以及异常错误，以提供完整的调试追踪信息。

#### 场景：客户端启动和关闭

**Given** 客户端程序启动
**When** 初始化完成
**Then** 应在 `client.log` 中记录启动信息，包括：
- 日志级别：INFO
- 内容：客户端启动、服务器地址、端口号

**Given** 客户端程序正常退出
**When** 清理资源完成
**Then** 应在 `client.log` 中记录关闭信息，包括：
- 日志级别：INFO
- 内容：客户端停止、原因（正常退出/异常）

### 场景：用户输入记录

**Given** 用户在提示符下输入内容
**When** 输入被接收
**Then** 应在 `client.log` 中记录输入内容，包括：
- 日志级别：DEBUG
- 内容：用户输入的前50个字符（避免敏感信息泄露）

### 场景：命令解析和执行

**Given** 用户输入以 `/` 开头的命令
**When** 命令被解析和执行
**Then** 应在 `client.log` 中记录命令执行，包括：
- 日志级别：INFO
- 内容：命令名称、参数（如果有）、执行结果

### 场景：网络连接管理

**Given** 客户端尝试连接服务器
**When** 连接成功或失败
**Then** 应在 `client.log` 中记录连接状态，包括：
- 日志级别：INFO（成功）/ WARNING（失败重试）/ ERROR（最终失败）
- 内容：服务器地址、端口、尝试次数、结果

**Given** 客户端与服务器断开连接
**When** 断开完成
**Then** 应在 `client.log` 中记录断开信息，包括：
- 日志级别：INFO
- 内容：断开原因

### 场景：消息收发

**Given** 客户端发送消息到服务器
**When** 消息编码并发送
**Then** 应在 `client.log` 中记录发送信息，包括：
- 日志级别：DEBUG
- 内容：消息类型、序列号、数据长度（不记录完整数据，避免日志过大）

**Given** 客户端接收服务器消息
**When** 消息解码并处理
**Then** 应在 `client.log` 中记录接收信息，包括：
- 日志级别：DEBUG
- 内容：消息类型、序列号、数据长度

### 场景：心跳机制

**Given** 客户端发送心跳
**When** 心跳发送成功
**Then** 应在 `client.log` 中记录心跳信息（DEBUG级别）：
- 心跳发送时间戳

**Given** 客户端接收心跳响应
**When** 心跳响应到达
**Then** 应在 `client.log` 中记录心跳响应（DEBUG级别）：
- 心跳响应时间戳

### 场景：流式输出状态

**Given** 服务器开始流式输出
**When** 接收到流式开始标记
**Then** 应在 `client.log` 中记录状态变化（INFO级别）：
- 流式输出开始

**Given** 接收流式数据块
**When** 每个数据块到达
**Then** 应在 `client.log` 中记录数据块（DEBUG级别）：
- 数据块长度

**Given** 流式输出结束
**When** 接收到流式结束标记
**Then** 应在 `client.log` 中记录状态变化（INFO级别）：
- 流式输出结束、总字符数

### 场景：文件下载

**Given** Agent 生成文件并提供下载
**When** 客户端接收下载提议
**Then** 应在 `client.log` 中记录下载信息（INFO级别）：
- 文件名、大小、校验和

**Given** 客户端通过 RDT 协议下载文件
**When** 下载完成
**Then** 应在 `client.log` 中记录下载结果（INFO级别）：
- 文件保存路径、下载耗时

### 场景：异常和错误

**Given** 客户端运行时发生异常
**When** 异常被捕获
**Then** 应在 `client.log` 中记录错误信息（ERROR级别）：
- 异常类型、错误消息、堆栈信息（如果是非预期错误）

**Given** 发生网络错误
**When** 错误被处理
**Then** 应在 `client.log` 中记录错误详情（WARNING级别）：
- 错误类型、重试策略

## 新增需求

### 需求：客户端日志记录器配置

客户端日志系统**必须**使用专门的日志记录器，支持独立的日志文件和可配置的日志级别。系统**应**提供 `get_client_logger()` 函数获取客户端日志记录器，使用 `client` 作为 logger 名称，输出到 `logs/client.log` 文件，默认级别为 INFO，同时支持 DEBUG 级别用于详细调试。

#### 场景：独立的客户端日志记录器

**Given** 客户端模块需要记录日志
**When** 初始化日志系统
**Then** 应使用 `get_client_logger()` 获取专门的客户端日志记录器：
- Logger 名称：`client`（或 `clients.cli`）
- 日志文件：`logs/client.log`
- 默认级别：INFO
- 支持 DEBUG 级别用于详细调试

#### 场景：网络通信日志记录器

**Given** 需要记录网络通信细节
**When** 初始化日志系统
**Then** 应使用独立的网络日志记录器：
- Logger 名称：`client.network`（或 `network`）
- 日志文件：`logs/network.log`
- 默认级别：DEBUG
- 专门记录消息收发、连接状态、心跳等

## 实现备注

1. **日志级别使用**：
   - INFO：关键操作和状态变化
   - DEBUG：详细信息（消息内容、数据块）
   - WARNING：可恢复的错误（重试、降级）
   - ERROR：严重错误（连接失败、异常）

2. **性能考虑**：
   - 避免在循环中频繁记录 INFO 级别日志
   - 消息内容只记录摘要，不记录完整数据
   - 使用异步日志写入（Python logging 默认）

3. **敏感信息保护**：
   - 不记录完整的用户输入（只记录前50字符）
   - 不记录消息的完整 data 字段
   - 过滤可能的敏感信息（密码、token 等）
