# 任务清单：增强日志系统

## 阶段1：日志基础设施改进

### 1.1 扩展日志配置模块
- [x] 在 `shared/utils/logger.py` 中添加 `get_llm_logger()` 函数
- [x] 更新 `get_client_logger()` 以支持更灵活的配置
- [x] 添加日志工具函数（如 `log_llm_request`、`log_llm_response`）

**验证**: 运行 `pytest tests/unit/test_logger.py`（如果存在）或手动验证

**依赖**: 无

---

### 1.2 创建独立的日志记录器
- [x] 为网络通信创建专门的 logger（network_logger）
- [x] 为 UI 交互创建专门的 logger（ui_logger）
- [x] 确保每个 logger 使用正确的名称前缀

**验证**: 检查日志文件中是否出现不同模块的日志

**依赖**: 1.1

---

## 阶段2：客户端日志增强

### 2.1 增强主程序日志 (clients/cli/main.py)
- [x] 记录客户端启动和关闭
- [x] 记录每个命令的解析和执行
- [x] 记录用户输入（摘要，前50字符）
- [x] 记录下载操作的开始和完成
- [x] 记录所有异常和错误

**验证**: 运行客户端，执行各种操作，检查 `client.log` 中是否有相应记录

**依赖**: 1.1

---

### 2.2 增强网络通信日志 (clients/cli/nplt_client.py)
- [x] 记录连接建立和断开
- [x] 记录每条消息的发送（类型、序列号、数据长度）
- [x] 记录每条消息的接收（类型、序列号、数据长度）
- [x] 记录心跳发送和接收
- [x] 记录流式输出状态变化（开始、进行中、结束）
- [x] 记录重连尝试和结果

**验证**: 查看日志文件中的网络事件记录

**依赖**: 1.2

---

### 2.3 增强 UI 日志 (clients/cli/ui.py)
- [x] 记录关键的 UI 状态变化
- [x] 记录错误显示和警告
- [x] 记录文件上传/下载的 UI 事件

**验证**: 触发各种 UI 事件，检查日志记录

**依赖**: 1.2

---

### 2.4 分离 NPLT 和 RDT 客户端日志
- [x] 在 `shared/utils/logger.py` 中添加 `get_rdt_logger()` 函数
- [x] 修改 `nplt_client.py` 使用 `get_network_logger()` 写入 network.log
- [x] 修改 `rdt_client.py` 使用日志系统替代 print() 语句
- [x] 为 RDTClient 和 RDTClientProtocol 添加日志记录
- [x] 记录 RDT 会话创建、数据包接收、ACK 发送等关键操作

**验证**: 运行客户端，检查 logs/network.log 和 logs/rdt.log 是否有相应记录

**依赖**: 1.2

---

## 阶段3：大模型调用日志

### 3.1 添加 LLM 请求日志 (server/llm/zhipu.py)
- [x] 在 `chat()` 方法开始处记录请求参数
- [x] 记录 model、temperature、max_tokens
- [x] 记录 messages 列表的摘要（每条消息的 role 和前100字符）
- [x] 使用 DEBUG 级别避免日志过多

**验证**: 发起聊天请求，检查日志中的请求记录

**依赖**: 1.1

---

### 3.2 添加 LLM 响应日志 (server/llm/zhipu.py)
- [x] 在 `chat()` 方法结束处记录完整响应
- [x] 记录响应长度和摘要（前200字符）
- [x] 记录调用耗时（使用 time.time()）
- [x] 记录 API 返回的元数据（如果有）

**验证**: 检查日志中的响应记录和耗时信息

**依赖**: 3.1

---

### 3.3 添加流式输出日志 (server/llm/zhipu.py)
- [x] 在 `chat_stream()` 中记录流式输出开始
- [x] 记录每个接收到的 chunk（DEBUG级别）
- [x] 记录流式输出结束和 finish_reason
- [x] 记录流式输出的总耗时和总字符数

**验证**: 发起流式聊天请求，检查日志中的流式输出记录

**依赖**: 3.1

---

### 3.4 添加 Embedding 日志 (server/llm/zhipu.py)
- [x] 在 `embed()` 方法中记录请求
- [x] 记录文本数量和长度
- [x] 记录响应维度
- [x] 记录调用耗时

**验证**: 执行语义搜索触发 embedding，检查日志

**依赖**: 3.1

---

### 3.5 添加错误日志 (server/llm/zhipu.py)
- [x] 捕获并记录所有 API 调用异常
- [x] 记录异常类型、消息和堆栈信息（ERROR级别）
- [x] 记录导致错误的请求上下文

**验证**: 模拟 API 错误（如错误的 API key），检查错误日志

**依赖**: 3.1

---

## 阶段4：配置和文档

### 4.1 更新配置文件 (config.yaml)
- [x] 添加 llm.logging 配置项
- [x] 添加 client.logging 配置项
- [x] 支持按模块设置不同的日志级别

**验证**: 修改配置文件，验证日志级别变化

**依赖**: 1.1

---

### 4.2 更新项目文档
- [ ] 在 `openspec/project.md` 中更新日志相关说明
- [ ] 记录新增的日志文件和格式
- [ ] 提供日志分析的示例

**验证**: 文档内容准确，可按文档操作

**依赖**: 4.1

---

## 阶段5：测试和验证

### 5.1 集成测试
- [x] 运行完整的客户端-服务器交互
- [x] 验证所有日志正确写入
- [x] 验证日志格式统一
- [x] 验证日志不影响性能

**验证**: 执行测试套件，检查所有测试通过

**依赖**: 所有前置任务

---

### 5.2 日志分析验证
- [ ] 检查 `client.log` 文件大小明显增加
- [ ] 检查 `llm.log` 包含所有 API 调用记录
- [ ] 验证可以通过日志追踪完整的请求流程
- [ ] 验证敏感信息（如 API key）未被记录

**验证**: 手动审查日志文件，确认符合标准

**依赖**: 5.1

---

## 可选任务

### 6.1 添加日志轮转配置
- [ ] 配置日志文件大小限制
- [ ] 配置日志文件保留数量
- [ ] 避免日志文件无限增长

**优先级**: 低

### 6.2 添加结构化日志
- [ ] 使用 JSON 格式记录关键日志
- [ ] 便于日志分析工具处理
- [ ] 保持可读性（同时支持文本格式）

**优先级**: 低
