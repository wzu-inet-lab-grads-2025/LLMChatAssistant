# 功能规范: 重构后系统验证

**功能分支**: `001-refactor-validation`
**创建时间**: 2026-01-02
**状态**: 草稿
**输入**: 用户描述: "校验重构后的前后端，后端agent功能是否都能正常调用返回预期结果，后端是否能正确返回结果发送给前端，前端能否正确解析后端结果，前后端文件上传下载功能等是否都正，文件检索等功能能否使用。"

## 澄清

### Session 2026-01-02

- Q: 测试方法要求是什么？ → A: 所有测试必须使用真实的大模型和API，不允许使用mock或模拟响应
- Q: 每个功能需要多少个测试样例？ → A: 每个功能验证必须包含不少于5个独立的真实测试样例，覆盖正常场景和边界情况

## 用户场景与测试 *(必填)*

### 用户故事 1 - Agent功能验证 (优先级: P1)

测试人员需要验证重构后的后端agent能够正确处理用户请求并返回预期结果。

**优先级原因**: Agent是系统的核心功能，如果agent不能正常工作，整个系统将无法提供基本服务。这是重构后最关键的验证点。

**独立测试**: 可以通过启动后端服务，发送各种类型的测试请求（简单对话、复杂查询、工具调用等），验证agent能否正确理解请求、调用合适的工具并返回格式正确的结果。

**验收场景**:

1. **给定** 后端服务已启动, **当** 发送简单对话请求时, **那么** 系统应返回正确格式的响应且内容符合预期
2. **给定** 后端服务已启动, **当** 发送需要工具调用的请求时, **那么** agent应正确识别并调用相应工具,返回工具执行结果
3. **给定** 后端服务已启动, **当** 发送包含错误输入的请求时, **那么** 系统应返回有意义的错误信息而不是崩溃
4. **给定** 后端服务已启动, **当** 发送需要多步推理的复杂请求时, **那么** agent应能正确处理并返回完整的推理结果

---

### 用户故事 2 - 前后端数据传输验证 (优先级: P1)

测试人员需要验证后端能够正确返回结果并通过协议发送给前端，前端能够正确解析后端返回的数据。

**优先级原因**: 前后端数据传输是系统通信的基础，如果数据传输或解析出现问题，用户将无法看到任何响应。这是重构后必须立即验证的关键功能。

**独立测试**: 可以通过启动前后端服务，在CLI客户端发送各种请求，监听网络数据包并检查前端接收到的数据结构是否正确，验证前端能否正确解析和显示数据。

**验收场景**:

1. **给定** 前后端服务都已启动, **当** 后端返回文本响应时, **那么** 前端应能正确接收并显示在用户界面上
2. **给定** 前后端服务都已启动, **当** 后端返回包含特殊字符或格式的文本时, **那么** 前端应能正确解析而不出现乱码或格式错误
3. **给定** 前后端服务都已启动, **当** 后端返回工具执行结果时, **那么** 前端应能正确解析结果结构并展示给用户
4. **给定** 前后端服务都已启动, **当** 后端返回错误信息时, **那么** 前端应能正确识别错误类型并显示友好的错误提示
5. **给定** 前后端服务都已启动, **当** 后端返回大型响应数据时, **那么** 前端应能完整接收而不出现数据截断

---

### 用户故事 3 - 文件上传下载功能验证 (优先级: P2)

测试人员需要验证重构后的系统支持文件上传和下载功能，且操作正确无误。

**优先级原因**: 文件操作是系统的重要功能，但不是最基本的功能。如果agent功能正常但文件操作有问题，用户仍可以进行基本的对话交互。因此优先级低于P1。

**独立测试**: 可以通过CLI客户端执行文件上传命令，验证文件能否正确传输到服务器指定位置；执行文件读取/下载命令，验证文件能否正确返回给客户端并保存。

**验收场景**:

1. **给定** 前后端服务都已启动, **当** 用户上传文本文件时, **那么** 文件应成功传输到服务器指定目录且内容完整
2. **给定** 前后端服务都已启动, **当** 用户上传二进制文件时, **那么** 文件应成功传输且数据完整性得到保证
3. **给定** 前后端服务都已启动, **当** 用户上传超大文件时, **那么** 系统应能正确处理（成功或返回明确的错误信息）
4. **给定** 前后端服务都已启动, **当** 用户下载已上传的文件时, **那么** 文件应能正确返回并保存到本地，内容与上传时一致
5. **给定** 前后端服务都已启动, **当** 用户尝试上传不允许的文件类型时, **那么** 系统应返回明确的错误提示
6. **给定** 前后端服务都已启动, **当** 网络传输中断时, **那么** 系统应能检测到错误并返回明确的错误信息

---

### 用户故事 4 - 文件检索功能验证 (优先级: P2)

测试人员需要验证重构后的系统能够正确执行文件检索和语义搜索功能。

**优先级原因**: 文件检索是增强功能，提升用户体验但不是基本对话所必需的。如果检索功能有问题，用户仍可以进行基本交互和文件操作。因此优先级为P2。

**独立测试**: 可以通过上传多个测试文件，然后执行文件检索和语义搜索查询，验证系统能否找到相关文件并返回准确的结果。

**验收场景**:

1. **给定** 系统中已上传多个文本文件, **当** 用户执行关键词搜索时, **那么** 系统应返回包含该关键词的所有文件列表
2. **给定** 系统中已上传多个文本文件, **当** 用户执行语义搜索时, **那么** 系统应返回与查询语义相关的文件，按相关度排序
3. **给定** 系统中已上传多个文本文件, **当** 用户查询不存在的关键词时, **那么** 系统应返回空结果而不是错误
4. **给定** 系统中已上传多个文本文件, **当** 用户执行模糊查询时, **那么** 系统应能返回部分匹配的结果
5. **给定** 系统中已包含向量索引, **当** 用户执行语义搜索时, **那么** 系统应使用索引快速返回结果而不需要重新索引

---

### 用户故事 5 - 历史记录功能验证 (优先级: P3)

测试人员需要验证重构后的系统能够正确保存和检索用户的对话历史。

**优先级原因**: 历史记录是便利性功能，不影响核心交互。即使历史记录功能有问题，用户仍可以进行实时对话。因此优先级为P3。

**独立测试**: 可以通过进行多次对话交互，然后查询历史记录，验证系统能否正确保存和返回之前的对话内容。

**验收场景**:

1. **给定** 用户已进行多次对话, **当** 用户查询历史记录时, **那么** 系统应返回按时间排序的所有历史对话
2. **给定** 用户已进行多次对话, **当** 用户查看特定会话的历史时, **那么** 系统应返回该会话的完整对话内容
3. **给定** 系统已运行一段时间, **当** 重启服务后, **那么** 历史记录应仍然存在并可访问

---

### 边界情况

- 当后端服务未启动时，前端尝试连接会发生什么？系统应返回明确的连接错误信息
- 当后端服务在处理请求时崩溃，前端会如何响应？前端应能检测到连接中断并显示错误
- 当上传文件名包含特殊字符或路径时，系统如何处理？系统应正确处理或拒绝并返回明确的错误
- 当同时上传多个大文件时，系统如何处理？系统应能处理并发请求或返回明确的资源限制错误
- 当向量索引损坏时，系统如何处理？系统应能检测到问题并尝试重建索引或返回明确的错误
- 当用户输入超长文本时，系统如何处理？系统应能处理或返回明确的长度限制错误

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须验证后端agent能够响应各种类型的用户请求（简单对话、工具调用、复杂查询）
- **FR-002**: 系统必须验证后端agent返回的响应格式正确且符合协议规范
- **FR-003**: 系统必须验证前端能够正确接收并显示后端返回的文本响应
- **FR-004**: 系统必须验证前端能够正确解析后端返回的工具执行结果
- **FR-005**: 系统必须验证前端能够正确显示后端返回的错误信息
- **FR-006**: 系统必须支持文件上传功能，文件能够正确传输到服务器指定位置
- **FR-007**: 系统必须支持文件下载功能，文件能够正确返回给客户端并保存
- **FR-008**: 系统必须验证上传和下载的文件内容完整性一致
- **FR-009**: 系统必须支持关键词搜索功能，能够找到包含指定关键词的文件
- **FR-010**: 系统必须支持语义搜索功能，能够返回与查询语义相关的文件
- **FR-011**: 系统必须能够保存用户的对话历史记录
- **FR-012**: 系统必须能够检索和展示历史对话记录
- **FR-013**: 系统必须在服务重启后保持历史记录的持久性
- **FR-014**: 系统必须在后端服务不可用时返回明确的连接错误信息
- **FR-015**: 系统必须在处理请求失败时返回明确的错误信息而不是崩溃
- **FR-015a**: 系统必须使用真实的大模型API进行所有agent功能测试，不允许使用模拟或mock响应
- **FR-015b**: 每个功能验证必须包含不少于5个独立的真实测试样例，覆盖正常场景和边界情况

### 章程合规需求 (Constitution Compliance Requirements)

- **FR-016**: 系统必须使用 Python 3.11 运行
- **FR-017**: 系统必须使用 uv 管理虚拟环境和依赖
- **FR-018**: 所有日志必须写入 logs 文件夹,格式为纯文本 (.log)
- **FR-019**: 所有测试必须是真实测试,不允许使用 mock
- **FR-020**: 所有功能实现必须是真实的,不允许虚假实现
- **FR-021**: 所有用户回复、注释和文档必须使用中文
- **FR-022**: 错误消息、日志和 API 文档必须使用中文
- **FR-023**: 每完成一个开发阶段并通过真实完整测试后必须 git 提交一个版本
- **FR-024**: 测试不通过不允许提交代码
- **FR-025**: 提交消息必须清晰描述该阶段完成的工作和测试结果

#### 安全合规需求 (Security Compliance Requirements)

- **FR-026**: 文件上传必须使用统一的路径白名单控制
- **FR-027**: 文件访问白名单配置必须存储在 config.yaml 的 file_access.allowed_paths 中
- **FR-028**: 路径验证器必须防止路径遍历攻击(如 ../ 规范化)
- **FR-029**: 必须维护黑名单模式以保护敏感文件(.env、.ssh/*、/etc/passwd 等)
- **FR-030**: 文件上传必须验证文件类型和文件大小
- **FR-031**: 必须实现多层安全验证(白名单、黑名单、大小限制、内容类型验证)
- **FR-032**: 所有文件访问和工具调用必须记录审计日志
- **FR-033**: 文件访问被拒绝时必须返回明确的拒绝理由

### 关键实体

- **测试用例**: 代表一个验证场景，包含测试输入、预期结果和实际结果的比较
- **验证报告**: 记录所有测试场景的执行结果，包括通过/失败状态和详细的错误信息
- **测试数据**: 用于测试的样本文件、对话记录和查询请求
- **错误日志**: 记录测试过程中发现的所有错误和异常情况

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 所有P1优先级测试用例（Agent功能、数据传输）必须100%通过，每个功能至少包含5个真实测试样例
- **SC-002**: 所有P2优先级测试用例（文件操作、检索功能）必须95%以上通过，每个功能至少包含5个真实测试样例
- **SC-003**: 所有P3优先级测试用例（历史记录）必须90%以上通过，每个功能至少包含5个真实测试样例
- **SC-004**: 所有agent功能测试必须使用真实的大模型API进行验证，不允许使用mock或模拟响应
- **SC-005**: 发现的所有严重错误（导致功能完全失效）必须在验证期间修复并重新测试
- **SC-006**: 发现的所有中等错误（影响功能但不完全阻止使用）必须记录在案并确定修复优先级
- **SC-007**: 生成的验证报告必须清晰列出每个测试场景的执行状态和结果
- **SC-008**: 文件上传下载的内容完整性验证必须100%准确
- **SC-009**: 语义搜索结果的准确性必须达到80%以上（基于人工评估）
- **SC-010**: 前后端数据传输的错误率必须低于1%（基于100次测试请求）

## 假设

- 假设测试环境已正确配置，包括Python 3.11、uv和必要的依赖
- 假设已配置有效的大模型API密钥（如智谱AI API key），并且API服务可用
- 假设测试人员熟悉系统的基本操作和命令行界面
- 假设测试数据（样本文件）已经准备好或可以在测试过程中生成
- 假设重构后的代码已经完成基本开发并可以进行测试
- 假设系统的配置文件（config.yaml）已正确设置，包括路径白名单等安全配置
- 假设测试将在受控环境中进行，不会受到外部网络或系统资源限制的影响
- 假设"预期结果"基于重构前的系统行为或文档中定义的功能需求
- 假设有足够的API配额用于执行至少5个测试样例×功能数量的真实API调用
