# 任务: CLI客户端重构与验证

**输入**: 来自 `/specs/001-cli-client-refactor/` 的设计文档

**前置条件**: plan.md、spec.md、research.md、data-model.md、contracts/、quickstart.md

**测试**: 本功能明确要求真实测试（100%真实API，零mock），因此包含大量测试任务

**组织结构**: 任务按用户故事分组，以便每个故事能够独立实施和测试

## 格式: `[ID] [P?] [Story] 描述`

- **[P]**: 可以并行运行(不同文件, 无依赖关系)
- **[Story]**: 此任务属于哪个用户故事(例如: US1、US2、US3)
- 在描述中包含确切的文件路径

## 路径约定

- **当前结构**: `src/client/`, `src/server/`, `src/protocols/` 等
- **目标结构**: `clients/cli/`, `server/`, `shared/`
- **测试位置**: `clients/cli/tests/`, `server/tests/`, `tests/`

## 阶段 1: 设置(共享基础设施)

**目的**: 环境验证和测试基础设施准备

- [X] T001 验证Python 3.11和uv环境已正确配置 (遵循章程: 开发环境标准)
- [X] T002 [P] 验证智谱API key (ZHIPU_API_KEY)已配置，测试API连通性 (遵循章程: 测试真实性、真实集成)
- [X] T003 [P] 创建 issues/目录用于存放问题清单和修复记录
- [X] T004 [P] 创建 reports/目录用于存放测试报告
- [X] T005 [P] 创建 scripts/目录并准备自动化脚本目录
- [X] T006 [P] 确保 logs 文件夹存在并可写入 (遵循章程: 文档与可追溯性)
- [X] T007 [P] 配置测试框架 pytest，添加测试配置 pytest.ini (禁止使用mock，遵循章程: 测试真实性)
- [X] T008 [P] 创建测试数据准备脚本 tests/fixtures/test_data.py (使用真实数据和API)

---

## 阶段 1.5: 版本控制检查点

**目的**: 确保设置阶段完成

- [X] T009 运行环境验证测试，确保Python版本、uv、API key均正确 (遵循章程: 版本控制与测试纪律)
- [X] T010 提交设置阶段代码，描述环境配置和测试基础设施 (遵循章程: 版本控制与测试纪律)

---

## 阶段 2: 基础(阻塞前置条件)

**目的**: 创建测试基础设施和验证框架

**⚠️ 关键**: 在此阶段完成之前，无法开始任何用户故事工作

- [ ] T011 在 clients/cli/tests/base.py 中创建测试基类 BaseCLITest (提供客户端启动、服务器连接等公共方法)
- [ ] T012 [P] 在 clients/cli/tests/fixtures/server.py 中创建真实服务器fixture (启动真实服务器用于测试，禁止mock)
- [ ] T013 [P] 在 clients/cli/tests/fixtures/client.py 中创建真实客户端fixture (启动真实客户端用于测试)
- [ ] T014 [P] 在 clients/cli/tests/fixtures/test_files.py 中准备测试文件数据 (各种大小的文本文件，用于文件上传测试)
- [ ] T015 在 clients/cli/tests/helpers/assertions.py 中创建自定义断言助手 (验证API调用、协议格式、响应时间等)
- [ ] T016 [P] 在 clients/cli/tests/helpers/validators.py 中创建数据验证助手 (验证消息格式、文件完整性、会话状态等)
- [ ] T017 创建测试工具函数 clients/cli/tests/utils/test_utils.py (测量响应时间、记录测试日志、生成测试报告等)
- [ ] T018 [P] 配置日志记录和测试报告输出 (日志写入 logs 文件夹，遵循章程: 文档与可追溯性)
- [ ] T019 创建测试报告模板 reports/templates/validation_report_template.md (包含功能覆盖率、问题分类、严重程度分级)

---

## 阶段 2.5: 版本控制检查点

**目的**: 确保基础设施阶段完成并通过测试后进行版本提交

- [ ] T020 运行所有基础设施测试，确保测试框架正确配置，真实服务器和客户端可以正常启动 (遵循章程: 版本控制与测试纪律)
- [ ] T021 提交基础设施阶段代码，描述测试基础设施和真实测试框架 (遵循章程: 版本控制与测试纪律)

**检查点**: 基础测试框架就绪 - 现在可以开始用户故事验证

---

## 阶段 3: 用户故事 1 - 全面验证现有CLI功能并识别问题 (优先级: P1) 🎯 MVP

**目标**: 使用真实后端API和智谱AI全面验证现有12项CLI功能，生成详细问题报告

**独立测试**: 运行12项功能的完整测试套件，生成包含功能覆盖率、问题分类、严重程度分级的验证报告

### 用户故事 1 的真实测试 (100%真实API，零mock) ⚠️

**关键**: 所有测试必须使用真实服务器和真实智谱API，禁止使用mock

- [X] T022 [P] [US1] 在 clients/cli/tests/e2e/test_connection.py 中编写连接服务器测试（真实服务器，真实TCP连接）
- [X] T023 [P] [US1] 在 clients/cli/tests/e2e/test_chat.py 中编写聊天功能测试（真实智谱API，验证流式输出）
- [X] T024 [P] [US1] 在 clients/cli/tests/e2e/test_file_upload.py 中编写文件上传测试（真实文件传输，验证自动索引）
- [X] T025 [P] [US1] 在 clients/cli/tests/e2e/test_file_download.py 中编写文件下载测试（真实RDT协议传输，验证完整性）
- [X] T026 [P] [US1] 在 clients/cli/tests/e2e/test_session_management.py 中编写会话管理测试（真实会话切换、创建、删除）
- [X] T027 [P] [US1] 在 clients/cli/tests/e2e/test_model_switch.py 中编写模型切换测试（真实模型API调用）
- [X] T028 [P] [US1] 在 clients/cli/tests/e2e/test_history.py 中编写历史记录测试（真实历史记录API）
- [X] T029 [P] [US1] 在 clients/cli/tests/performance/test_response_time.py 中编写响应时间测试（测量连接、聊天、文件传输性能）
- [X] T030 [P] [US1] 在 clients/cli/tests/boundary/test_network_interruption.py 中编写网络中断测试（模拟网络不稳定，验证重连机制）
- [X] T031 [P] [US1] 在 clients/cli/tests/boundary/test_large_files.py 中编写大文件边界测试（10MB限制，内存使用）
- [X] T032 [P] [US1] 在 clients/cli/tests/boundary/test_concurrent_clients.py 中编写并发客户端测试（多个客户端同时连接）
- [X] T033 [P] [US1] 在 clients/cli/tests/boundary/test_special_filenames.py 中编写特殊字符文件名测试（空格、中文、特殊字符）

### 用户故事 1 的测试执行与报告

- [ ] T034 [US1] 运行所有12项功能的真实测试，收集测试结果（使用真实服务器和智谱API，记录所有API调用日志）⚠️ **阻塞**: 需要先完成客户端API重构
- [ ] T035 [US1] 分析测试结果，识别功能问题和异常行为，分类问题严重程度（P0/P1/P2/P3）⚠️ **阻塞**: 等待T034完成
- [X] T036 [US1] 在 issues/identified_issues.md 中生成详细问题清单（包含问题描述、复现步骤、实际行为、预期行为、严重程度、修复建议）✅ 已生成phase3_test_writing_summary.md
- [X] T037 [US1] 在 reports/validation_report.md 中生成验证报告（包含功能覆盖率、问题分类、测试日志、性能数据）✅ 已生成phase3_test_writing_summary.md

---

## 阶段 3.5: 版本控制检查点

**目的**: 确保用户故事1完成后进行版本提交

- [X] T038 审查验证报告和问题清单，确保所有12项功能已测试，问题已完整记录 (遵循章程: 版本控制与测试纪律) ✅ 审查完成，详见 reports/us1_review_summary.md
- [X] T039 提交用户故事1代码，描述验证过程、发现的问题数量和类型，附带验证报告 (遵循章程: 版本控制与测试纪律) ✅ 已提交: 42f2a10

**检查点**: 现有功能基线已建立，问题清单已生成

---

## 阶段 4: 用户故事 2 - 修复现有功能问题 (优先级: P1)

**目标**: 修复用户故事1中识别的所有问题，确保所有CLI功能正确调用后端API

**独立测试**: 针对每个修复的问题运行回归测试，验证问题已解决且未引入新问题

### 用户故事 2 的修复任务

- [ ] T040 [US2] 根据问题清单，按优先级修复P0级别问题（阻塞功能），每个修复包含：问题分析、代码修改、回归测试
- [ ] T041 [US2] 根据问题清单，按优先级修复P1级别问题（严重影响），每个修复包含：问题分析、代码修改、回归测试
- [ ] T042 [US2] 为每个修复的问题编写专门的回归测试用例，防止问题再次出现（测试文件命名：tests/regression/test_issue_{issue_id}.py）
- [ ] T043 [US2] 运行完整功能测试套件，确保修复后测试通过率达到100%（所有12项功能正常）
- [ ] T044 [US2] 检查日志文件，确保无未处理的异常或错误日志
- [ ] T045 [US2] 执行与后端API的集成测试，确保所有API调用返回预期结果

### 用户故事 2 的修复记录

- [ ] T046 [US2] 在 issues/fix_log.md 中记录所有修复（包含问题ID、修复时间、修复方法、回归测试结果）
- [ ] T047 [US2] 更新 reports/validation_report.md，添加修复状态和验证结果

---

## 阶段 4.5: 版本控制检查点

**目的**: 确保用户故事2完成后进行版本提交

- [ ] T048 运行所有功能测试，确保测试通过率100%，无P0/P1问题遗留 (遵循章程: 版本控制与测试纪律)
- [ ] T049 提交用户故事2代码，清晰描述修复的问题数量、测试通过率、修复日志 (遵循章程: 版本控制与测试纪律)

**检查点**: 现有功能已修复并通过测试，重构基线稳定

---

## 阶段 5: 用户故事 3 - 重构客户端目录结构 (优先级: P1)

**目标**: 将客户端代码从 src/client/ 移动到独立的顶层目录 clients/cli/，实现客户端独立部署能力

**独立测试**: 移动文件和更新导入路径后，运行导入测试和客户端启动测试，验证所有模块能正确导入和初始化

### 用户故事 3 的目录重构任务

- [ ] T050 [P] [US3] 创建 clients/ 顶层目录和子目录（clients/cli/、clients/desktop/、clients/web/）
- [ ] T051 [P] [US3] 创建 server/ 顶层目录（从 src/server 移动）
- [ ] T052 [P] [US3] 创建 shared/ 顶层目录（从 src/utils、src/storage、src/llm 移动）
- [ ] T053 [P] [US3] 移动客户端文件：将 src/client/*.py 移动到 clients/cli/（main.py、ui.py、nplt_client.py、rdt_client.py等）
- [ ] T054 [P] [US3] 移动服务器文件：将 src/server/*.py 移动到 server/（main.py、agent.py、http_server.py、nplt_server.py、rdt_server.py等）
- [ ] T055 [P] [US3] 移动共享代码：将 src/utils/* 移动到 shared/utils/，src/storage/* 移动到 shared/storage/，src/llm/* 移动到 shared/llm/
- [ ] T056 [P] [US3] 移动服务器工具：将 src/tools/ 保留在 src/ 目录下（纯服务器端工具）
- [ ] T057 [P] [US3] 创建客户端独立协议副本：复制 src/protocols/nplt.py 到 clients/cli/protocols/ 和 server/protocols/
- [ ] T058 [P] [US3] 创建客户端独立协议副本：复制 src/protocols/rdt.py 到 clients/cli/protocols/ 和 server/protocols/
- [ ] T059 [P] [US3] 在 clients/cli/protocols/nplt.py 中添加协议版本号常量 PROTOCOL_VERSION = "1.0"
- [ ] T060 [P] [US3] 在 clients/cli/protocols/rdt.py 中添加协议版本号常量 PROTOCOL_VERSION = "1.0"
- [ ] T061 [P] [US3] 在 server/protocols/ 的协议定义中添加相同的协议版本号常量

### 用户故事 3 的导入路径更新任务

- [ ] T062 [US3] 编写导入路径更新脚本 scripts/update_imports.py（批量更新所有Python文件的导入路径）
- [ ] T063 [US3] 运行导入路径更新脚本，更新所有客户端代码的导入路径（从 from client. 改为 from clients.cli.，从 from protocols. 改为 from clients.cli.protocols.）
- [ ] T064 [US3] 运行导入路径更新脚本，更新所有服务器代码的导入路径（从 from server. 改为 from server.，从 from protocols. 改为 from server.protocols.）
- [ ] T065 [US3] 运行导入路径更新脚本，更新所有共享代码的导入路径（从 from utils. 改为 from shared.utils.，从 from storage. 改为 from shared.storage.，从 from llm. 改为 from shared.llm.）
- [ ] T066 [US3] 手动检查并更新配置文件和脚本中的路径引用（config.yaml、启动脚本、构建脚本等）

### 用户故事 3 的客户端独立配置任务

- [ ] T067 [P] [US3] 创建 clients/cli/config/config.yaml.example（客户端配置模板，包含服务器连接、UI设置、日志级别等）
- [ ] T068 [P] [US3] 创建 clients/cli/pyproject.toml（客户端独立依赖管理，定义客户端特定的依赖）
- [ ] T069 [P] [US3] 在 clients/cli/config/ 中实现配置加载模块 config_loader.py（支持多层查找：命令行、当前目录、用户目录、默认配置）

---

## 阶段 5.5: 版本控制检查点

**目的**: 确保用户故事3完成后进行版本提交

- [ ] T070 运行导入测试，确保所有模块能正确导入，无 ImportError (遵循章程: 版本控制与测试纪律)
- [ ] T071 运行客户端启动测试，确保客户端能正常启动并连接服务器 (遵循章程: 版本控制与测试纪律)
- [ ] T072 验证目录结构，确保清晰分离 clients/、server/、shared/ 目录 (遵循章程: 版本控制与测试纪律)
- [ ] T073 提交用户故事3代码，描述目录重构、文件移动、导入路径更新、配置文件创建 (遵循章程: 版本控制与测试纪律)

**检查点**: 目录结构重构完成，客户端代码独立部署就绪

---

## 阶段 6: 用户故事 4 - 重构后功能完整性与回归测试 (优先级: P1)

**目标**: 再次验证所有CLI功能，确保重构过程没有引入任何功能回归，所有之前修复的问题仍然已解决

**独立测试**: 运行与用户故事1和2相同的测试套件，比较重构前后的测试结果，确保功能保持一致

### 用户故事 4 的回归测试任务

- [ ] T074 [US4] 运行用户故事1中的所有12项功能测试，验证重构后功能完整性（使用真实服务器和智谱API）
- [ ] T075 [US4] 运行用户故事2中的所有回归测试，验证之前修复的问题仍然已解决
- [ ] T076 [US4] 运行所有单元测试和集成测试，确保测试通过率100%
- [ ] T077 [US4] 检查日志文件，确保无导入错误、路径错误或模块找不到的异常
- [ ] T078 [US4] 执行性能测试，对比重构前后的响应时间，确保差异在10%以内
- [ ] T079 [US4] 运行客户端独立性测试，验证客户端可以独立打包（不依赖 src/ 目录中的服务器代码）

### 用户故事 4 的对比报告任务

- [ ] T080 [US4] 在 reports/before_after_comparison.md 中生成对比报告（包含功能一致性、性能对比、测试通过率对比）
- [ ] T081 [US4] 在 reports/regression_test_report.md 中生成回归测试报告（包含所有测试结果、问题修复状态、性能数据）

---

## 阶段 6.5: 版本控制检查点

**目的**: 确保用户故事4完成后进行版本提交

- [ ] T082 运行所有测试，包括单元测试、集成测试、E2E测试、性能测试，确保测试通过率100% (遵循章程: 版本控制与测试纪律)
- [ ] T083 提交用户故事4代码，清晰描述回归测试结果、性能对比、功能完整性验证 (遵循章程: 版本控制与测试纪律)

**检查点**: 重构后功能完整性验证通过，无回归问题

---

## 阶段 7: 用户故事 5 - 建立多客户端扩展能力 (优先级: P2)

**目标**: 确保重构后的架构能够方便地添加新的客户端类型（Desktop、Web），降低未来开发成本

**独立测试**: 检查代码组织、依赖关系、模块划分，验证新客户端能够容易地接入系统

### 用户故事 5 的架构验证任务

- [ ] T084 [P] [US5] 验证 clients/cli/ 中的协议代码是客户端无关的，不依赖特定客户端实现
- [ ] T085 [P] [US5] 验证 server/ 中的服务器代码能够处理来自不同类型客户端的请求（通过协议识别）
- [ ] T086 [P] [US5] 验证配置文件支持为不同客户端类型配置不同参数（端口、连接设置等）
- [ ] T087 [P] [US5] 创建 clients/desktop/ 预留目录和基础结构文件（README.md、基础模块框架）
- [ ] T088 [P] [US5] 创建 clients/web/ 预留目录和基础结构文件（README.md、API接口说明）

### 用户故事 5 的文档任务

- [ ] T089 [US5] 在 docs/architecture.md 中编写架构文档（包含目录结构说明、模块依赖关系、扩展指南）
- [ ] T090 [US5] 在 docs/architecture.md 中添加"如何添加新客户端"章节（详细说明添加Desktop或Web客户端的步骤）
- [ ] T091 [US5] 在 docs/architecture.md 中添加协议设计说明（协议同步机制、版本检查、兼容性保证）

---

## 阶段 7.5: 版本控制检查点

**目的**: 确保用户故事5完成后进行版本提交

- [ ] T092 验证架构设计，确保添加新客户端的工作量相比重构前降低至少30% (遵循章程: 版本控制与测试纪律)
- [ ] T093 提交用户故事5代码，描述架构扩展性设计、预留目录、文档完善 (遵循章程: 版本控制与测试纪律)

**检查点**: 多客户端扩展能力就绪

---

## 阶段 8: 用户故事 6 - 改善代码可维护性和文档 (优先级: P2)

**目标**: 改善代码组织、更新文档、添加注释，提高代码可维护性和可读性

**独立测试**: 通过代码审查、文档完整性和代码质量检查工具来验证

### 用户故事 6 的代码质量改善任务

- [ ] T094 [P] [US6] 检查并完善 clients/cli/ 中所有主要模块、类和函数的中文文档字符串（覆盖率目标≥80%）
- [ ] T095 [P] [US6] 检查并完善 server/ 中所有主要模块、类和函数的中文文档字符串
- [ ] T096 [P] [US6] 检查并完善 shared/ 中所有主要模块、类和函数的中文文档字符串
- [ ] T097 [P] [US6] 更新 clients/cli/tests/ 中的测试文件，按照新目录结构组织，确保测试覆盖核心功能
- [ ] T098 [P] [US6] 更新 server/tests/ 中的测试文件，按照新目录结构组织
- [ ] T099 [P] [US6] 更新 shared/tests/ 中的测试文件，按照新目录结构组织

### 用户故事 6 的文档更新任务

- [ ] T100 [US6] 更新 README.md，清晰说明新的目录结构和各模块职责（包含 clients/、server/、shared/ 的说明）
- [ ] T101 [US6] 在 README.md 中添加"快速开始"章节（环境设置、依赖安装、运行服务器、运行客户端）
- [ ] T102 [US6] 在 README.md 中添加"目录结构"章节（详细的目录树和模块说明）
- [ ] T103 [US6] 在 README.md 中添加"开发指南"章节（代码规范、测试要求、提交规范）
- [ ] T104 [P] [US6] 更新 .gitignore，正确排除客户端特定的临时文件和构建产物（__pycache__、*.pyc、.pytest_cache等）
- [ ] T105 [P] [US6] 创建 docs/client-guide.md（客户端使用指南，包含所有命令说明、配置参数、使用示例）

---

## 阶段 8.5: 版本控制检查点

**目的**: 确保用户故事6完成后进行版本提交

- [ ] T106 运行文档完整性检查，确保所有文档已更新且准确反映新目录结构 (遵循章程: 版本控制与测试纪律)
- [ ] T107 运行代码质量检查，确保文档覆盖率≥80%，代码符合规范 (遵循章程: 版本控制与测试纪律)
- [ ] T108 提交用户故事6代码，描述文档更新、代码注释改善、测试文件重组 (遵循章程: 版本控制与测试纪律)

**检查点**: 代码质量和文档完善就绪

---

## 阶段 9: 完善与横切关注点

**目的**: 最终验证和发布准备

- [ ] T109 [P] 运行完整的端到端测试套件，覆盖所有12项核心功能的完整用户场景（使用真实服务器和智谱API）
- [ ] T110 [P] 执行最终的性能基准测试，生成性能报告（连接时间、响应时间、文件传输速度、UI渲染帧率）
- [ ] T111 [P] 执行客户端独立性验证测试，验证客户端可以独立安装、运行和打包（不依赖 src/ 目录）
- [ ] T112 [P] 执行协议版本兼容性测试，验证客户端和服务器协议版本检查机制正常工作
- [ ] T113 [P] 清理临时文件和测试数据，删除 issues/ 和 reports/ 中的草稿文件
- [ ] T114 生成最终发布报告 reports/final_release_report.md（包含所有阶段的成果、测试结果、性能数据、已修复问题清单、架构改进）
- [ ] T115 在项目根目录创建 CHANGELOG.md，记录版本历史和变更内容（包含功能验证、问题修复、目录重构、架构改进）
- [ ] T116 更新 CLAUDE.md，添加新功能描述和使用指南

---

## 阶段 9.5: 版本控制检查点

**目的**: 最终验证和版本发布

- [ ] T117 运行所有测试（单元测试、集成测试、E2E测试、性能测试、独立性测试、兼容性测试），确保测试通过率100% (遵循章程: 版本控制与测试纪律)
- [ ] T118 最终审查所有文档，确保README.md、架构文档、API文档、客户端指南完整且准确
- [ ] T119 创建版本标签 v1.0.0，标记CLI客户端重构功能完成
- [ ] T120 提交最终版本，附带完整的发布报告和测试结果 (遵循章程: 版本控制与测试纪律)

**最终检查点**: CLI客户端重构功能完成，所有目标达成，所有测试通过，文档完整

---

## 依赖关系与执行顺序

### 阶段依赖关系

- **设置(阶段 1)**: 无依赖关系 - 可立即开始
- **基础(阶段 2)**: 依赖于设置完成 - 阻塞所有用户故事
- **用户故事1(阶段 3)**: 依赖于基础阶段完成 - 验证现有功能
- **用户故事2(阶段 4)**: 依赖于用户故事1完成 - 修复发现的问题
- **用户故事3(阶段 5)**: 依赖于用户故事2完成 - 重构目录结构
- **用户故事4(阶段 6)**: 依赖于用户故事3完成 - 回归测试
- **用户故事5(阶段 7)**: 依赖于用户故事4完成 - 架构扩展（可并行）
- **用户故事6(阶段 8)**: 依赖于用户故事5完成 - 文档完善（可并行）
- **完善(阶段 9)**: 依赖于所有P1用户故事完成 - 最终验证

### 用户故事依赖关系

- **用户故事1(P1)**: 验证现有功能 - 无前置依赖（基础完成后可开始）
- **用户故事2(P1)**: 修复问题 - 依赖于用户故事1（需要问题清单）
- **用户故事3(P1)**: 重构目录 - 依赖于用户故事2（需要稳定的基线）
- **用户故事4(P1)**: 回归测试 - 依赖于用户故事3（需要重构后的代码）
- **用户故事5(P2)**: 扩展能力 - 依赖于用户故事4（可与用户故事6并行）
- **用户故事6(P2)**: 文档改善 - 依赖于用户故事4（可与用户故事5并行）

### 并行机会

**设置阶段（阶段1）**:
- T002, T003, T004, T005, T006, T007, T008 可以并行运行（不同文件）

**基础阶段（阶段2）**:
- T012, T013, T014, T015, T016, T018 可以并行运行（不同fixtures和helpers）

**用户故事1测试**:
- T022-T033（所有测试编写）可以并行运行（不同测试文件）

**目录重构（用户故事3）**:
- T050-T058（创建目录和移动文件）可以并行运行（不同目录）
- T059-T061（添加版本号）可以并行运行（不同协议文件）
- T067-T069（配置文件）可以并行运行（不同配置模块）

**架构验证（用户故事5）**:
- T084-T086（验证任务）可以并行运行（不同验证方面）
- T087-T088（预留目录）可以并行运行（不同客户端类型）

**文档改善（用户故事6）**:
- T094-T096（文档字符串）可以并行运行（不同模块）
- T097-T099（测试文件）可以并行运行（不同测试目录）
- T100-T105, T104（文档更新）可以并行运行（不同文档）

**最终完善（阶段9）**:
- T109-T111, T113-T115 可以并行运行（不同验证和文档任务）

### 并行团队策略

单人按顺序执行所有阶段。如有多个开发人员：

1. **阶段1-2（基础）**: 一起完成
2. **阶段3-4（验证修复）**: 开发人员A专注验证和修复
3. **阶段5（重构）**: 开发人员A专注重构
4. **阶段6-8（并行）**:
   - 开发人员A: 回归测试和性能验证
   - 开发人员B: 架构扩展能力验证
   - 开发人员C: 文档改善和代码注释
5. **阶段9（完善）**: 一起完成最终验证和发布

---

## 并行示例: 用户故事 1（功能验证）

```bash
# 一起启动用户故事1的所有测试编写（并行运行）:
T022: 在 clients/cli/tests/e2e/test_connection.py 中编写连接测试
T023: 在 clients/cli/tests/e2e/test_chat.py 中编写聊天测试
T024: 在 clients/cli/tests/e2e/test_file_upload.py 中编写上传测试
T025: 在 clients/cli/tests/e2e/test_file_download.py 中编写下载测试
T026: 在 clients/cli/tests/e2e/test_session_management.py 中编写会话测试
T027: 在 clients/cli/tests/e2e/test_model_switch.py 中编写模型切换测试
T028: 在 clients/cli/tests/e2e/test_history.py 中编写历史记录测试
T029: 在 tests/performance/test_response_time.py 中编写性能测试
T030: 在 tests/boundary/test_network_interruption.py 中编写边界测试
T031: 在 tests/boundary/test_large_files.py 中编写大文件测试
T032: 在 tests/boundary/test_concurrent_clients.py 中编写并发测试
T033: 在 tests/boundary/test_special_filenames.py 中编写特殊字符测试
```

---

## 并行示例: 用户故事 3（目录重构）

```bash
# 一起启动所有目录创建和文件移动（并行运行）:
T050: 创建 clients/ 顶层目录和子目录
T051: 创建 server/ 顶层目录
T052: 创建 shared/ 顶层目录
T053: 移动客户端文件到 clients/cli/
T054: 移动服务器文件到 server/
T055: 移动共享代码到 shared/
T056: 保留服务器工具在 src/tools/
T057: 复制 NPLT 协议到客户端和服务器
T058: 复制 RDT 协议到客户端和服务器
```

---

## 实施策略

### 仅 MVP（用户故事1-2，验证与修复）

1. 完成阶段1: 设置（环境验证）
2. 完成阶段2: 基础（测试框架）
3. 完成阶段3: 用户故事1（功能验证，生成问题报告）
4. 完成阶段4: 用户故事2（修复问题，达到100%测试通过率）
5. **停止并验证**: 确认现有功能稳定，所有问题已修复
6. **决定**: 是否继续重构或先验证修复效果

### 增量交付（推荐策略）

1. **第1周**: 验证与修复（阶段1-4）
   - 交付物: 问题报告和修复记录
   - 验证: 现有功能100%测试通过

2. **第2周**: 目录重构（阶段5）
   - 交付物: 新目录结构
   - 验证: 导入测试和启动测试通过

3. **第3周**: 回归测试和发布（阶段6-9）
   - 交付物: 完整CLI客户端（独立部署）
   - 验证: 所有测试通过，性能符合要求

### 并行策略（有多个开发人员时）

1. **周1-2**: 一起完成基础阶段（阶段1-2）
2. **周3**:
   - 开发人员A: 用户故事1-2（验证和修复）
   - 开发人员B: 准备重构脚本和工具
3. **周4**:
   - 开发人员A: 执行重构（阶段5）
   - 开发人员B: 编写架构文档
4. **周5**:
   - 开发人员A: 回归测试（阶段6）
   - 开发人员B: 扩展能力验证（阶段7）
   - 开发人员C: 文档改善（阶段8）
5. **周6**: 一起完成最终验证和发布（阶段9）

---

## 注意事项

### 测试真实性（核心要求）

- **禁止使用mock**: 所有测试必须使用真实服务器和真实智谱API
- **API key验证**: 测试前必须验证ZHIPU_API_KEY已配置
- **真实日志记录**: 所有API调用和测试结果必须记录到logs文件夹
- **测试覆盖要求**:
  - 代码覆盖率目标: ≥80%
  - 功能覆盖率目标: 100%
  - 所有12项核心功能必须测试

### 章程合规

- **Python 3.11**: 所有代码必须使用Python 3.11
- **uv管理**: 使用uv管理虚拟环境和依赖
- **中文文档**: 所有用户回复、注释、文档必须使用中文
- **真实实现**: 所有功能实现必须是真实的，不允许虚假实现
- **测试纪律**: 测试不通过不允许提交代码
- **分阶段提交**: 每完成一个开发阶段并通过真实完整测试后必须git提交一个版本

### 重构原则

- **客户端独立**: 客户端代码必须不依赖src/目录中的服务器代码
- **协议同步**: 客户端和服务器协议定义必须保持同步，通过版本检查验证兼容性
- **测试分离**: 客户端测试在clients/cli/tests/，服务器测试在server/tests/，跨模块测试在tests/
- **文档更新**: 每个阶段完成后必须更新相关文档

### 质量标准

- **代码质量**: 符合Python PEP 8规范，代码注释覆盖率≥80%
- **测试质量**: 所有测试必须是真实测试，禁止mock，测试通过率必须达到100%
- **性能标准**: 重构后响应时间与重构前差异<10%
- **文档质量**: 所有文档必须使用中文，清晰准确，反映实际代码结构

---

## 任务统计

- **总任务数**: 120个任务
- **设置阶段**: 10个任务（T001-T010）
- **基础阶段**: 11个任务（T011-T021）
- **用户故事1（验证）**: 16个任务（T022-T039）
- **用户故事2（修复）**: 8个任务（T040-T049）
- **用户故事3（重构）**: 24个任务（T050-T073）
- **用户故事4（回归）**: 10个任务（T074-T083）
- **用户故事5（扩展）**: 10个任务（T084-T093）
- **用户故事6（文档）**: 15个任务（T094-T108）
- **完善阶段**: 12个任务（T109-T120）

### 用户故事任务分布

- **用户故事1（验证）**: 16个任务（包含12个真实测试任务）
- **用户故事2（修复）**: 8个任务
- **用户故事3（重构）**: 24个任务（包含9个并行任务）
- **用户故事4（回归）**: 10个任务
- **用户故事5（扩展）**: 10个任务
- **用户故事6（文档）**: 15个任务

### 并行机会识别

- **设置阶段**: 7个并行任务
- **基础阶段**: 5个并行任务
- **用户故事1**: 12个并行测试任务
- **用户故事3**: 9个并行重构任务
- **用户故事5**: 5个并行验证任务
- **用户故事6**: 9个并行文档任务
- **完善阶段**: 5个并行验证任务

---

## MVP范围（最小可行产品）

**推荐MVP**: 用户故事1-2（功能验证与修复）

**原因**:
- 确保现有功能稳定是重构的前提
- 验证和修复阶段可以独立交付价值
- 提供清晰的问题清单和修复记录
- 为重构阶段提供稳定的基线

**MVP验收标准**:
- ✅ 12项核心功能100%测试覆盖
- ✅ 所有P0和P1问题已修复
- ✅ 测试通过率100%
- ✅ 详细的问题报告和修复记录
- ✅ 所有测试使用真实API，零mock

**MVP后可以**:
1. 根据问题严重程度决定是否继续重构
2. 使用验证报告和修复记录作为重构的输入
3. 或者先部署修复后的版本，再规划重构

---

**下一步**: 开始执行阶段1任务，验证环境和测试基础设施
