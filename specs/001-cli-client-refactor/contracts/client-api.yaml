# CLI客户端API契约

**版本**: 1.0.0
**日期**: 2026-01-01
**协议**: NPLT v1.0, RDT v1.0

## 概述

本文档定义CLI客户端与服务器之间的API契约，包括通信协议、消息格式、命令接口等。

## 通信协议

### NPLT协议 (TCP:9999)

**协议格式**: `Type(1B) + Seq(2B) + Len(2B) + Data(<=64KB)`

**字段说明**:
- `Type`: 消息类型（1字节）
- `Seq`: 序列号（2字节，大端序）
- `Len`: 数据长度（2字节，大端序）
- `Data`: 数据内容（最多64KB）

### RDT协议 (UDP:9998)

**协议格式**: `Seq(4B) + Ack(4B) + Window(1B) + Flags(1B) + Checksum(2B) + Data(<=1000B)`

**字段说明**:
- `Seq`: 序列号（4字节，大端序）
- `Ack`: 确认号（4字节，大端序）
- `Window`: 滑动窗口大小（1字节）
- `Flags`: 标志位（1字节）
- `Checksum`: CRC16校验和（2字节）
- `Data`: 数据内容（最多1000字节）

## 消息类型定义

### NPLT消息类型

| 类型值 | 名称 | 方向 | 数据格式 | 说明 |
|--------|------|------|----------|------|
| 0x01 | CHAT_TEXT | 双向 | 纯文本/JSON | 聊天文本消息 |
| 0x02 | AGENT_THOUGHT | S→C | JSON | Agent状态更新 |
| 0x03 | DOWNLOAD_OFFER | S→C | JSON | 文件下载提议 |
| 0x04 | FILE_METADATA | 双向 | JSON | 文件元数据 |
| 0x05 | FILE_DATA | S→C | 二进制 | 文件数据块 |
| 0x10 | SESSION_SWITCH | C→S | JSON | 会话切换请求 |
| 0x11 | HISTORY_REQUEST | C→S | JSON | 历史记录请求 |
| 0x12 | HISTORY_RESPONSE | S→C | JSON | 历史记录响应 |
| 0x13 | MODEL_SWITCH | C→S | JSON | 模型切换请求 |
| 0x14 | FILE_UPLOAD | C→S | 二进制+JSON | 文件上传 |

**方向说明**: S=服务器, C=客户端, →=发送方向

### 消息数据格式

#### CHAT_TEXT (0x01)

**纯文本格式**（用户消息）:
```
Data: <用户输入的文本内容>
```

**JSON格式**（AI回复，包含工具调用）:
```json
{
  "content": "回复内容",
  "role": "assistant",
  "tool_calls": [
    {
      "tool_name": "semantic_search",
      "arguments": {"query": "数据库配置"},
      "status": "success",
      "result": "config.yaml"
    }
  ]
}
```

#### AGENT_THOUGHT (0x02)

```json
{
  "type": "thinking",
  "content": "正在分析用户请求...",
  "stream_start": true
}
```

```json
{
  "type": "tool_call",
  "tool_name": "semantic_search",
  "arguments": {"query": "数据库配置"}
}
```

```json
{
  "type": "generating",
  "content": "正在生成回复..."
}
```

**type字段**: `thinking` | `tool_call` | `generating`

#### DOWNLOAD_OFFER (0x03)

```json
{
  "file_id": "uuid-string",
  "filename": "config.yaml",
  "size": 1024,
  "file_path": "/path/to/config.yaml",
  "protocol": "RDT",
  "port": 9998
}
```

**protocol字段**: `RDT` | `HTTP` | `NPLT`

#### SESSION_SWITCH (0x10)

```json
{
  "session_id": "uuid-string",
  "action": "switch"
}
```

**action字段**: `switch` | `new` | `delete` | `list`

#### HISTORY_REQUEST (0x11)

```json
{
  "session_id": "uuid-string",
  "count": 10
}
```

#### HISTORY_RESPONSE (0x12)

```json
{
  "session_id": "uuid-string",
  "messages": [
    {
      "role": "user",
      "content": "你好",
      "timestamp": "2026-01-01T12:00:00"
    },
    {
      "role": "assistant",
      "content": "你好！有什么我可以帮助你的吗？",
      "timestamp": "2026-01-01T12:00:01",
      "tool_calls": []
    }
  ]
}
```

#### MODEL_SWITCH (0x13)

```json
{
  "model": "glm-4.5-flash"
}
```

## CLI命令接口

### 命令格式

```
/command [arguments...]
```

### 命令列表

#### /help

**描述**: 显示帮助信息

**参数**: 无

**示例**:
```
/help
```

**响应**:
```
可用命令:
  /help              显示此帮助信息
  /quit              退出客户端
  /upload <file> [note]   上传文件
  /model <model>    切换模型
  /sessions         列出所有会话
  /switch <id>      切换到指定会话
  /new              创建新会话
  /delete <id>      删除指定会话
  /history [count]  查看历史记录
  /clear            清空当前会话历史
```

#### /quit

**描述**: 退出客户端

**参数**: 无

**示例**:
```
/quit
```

#### /upload

**描述**: 上传文件到服务器

**参数**:
- `<file>`: 文件路径（必需）
- `[note]`: 用户说明（可选）

**示例**:
```
/upload /path/to/test.txt 测试文件
/upload config.yaml
```

**服务器响应**:
```json
{
  "success": true,
  "file_id": "uuid-string",
  "filename": "test.txt",
  "size": 1024,
  "indexed": true
}
```

#### /model

**描述**: 切换AI模型

**参数**:
- `<model>`: 模型名称

**支持的模型**:
- `glm-4-flash` (免费，推荐用于测试)
- `glm-4.5-flash` (免费，性能更好)
- `glm-4` (付费)

**示例**:
```
/model glm-4.5-flash
```

**服务器响应**:
```json
{
  "success": true,
  "model": "glm-4.5-flash"
}
```

#### /sessions

**描述**: 列出所有会话

**参数**: 无

**示例**:
```
/sessions
```

**服务器响应**:
```json
{
  "sessions": [
    {
      "session_id": "uuid-1",
      "created_at": "2026-01-01T10:00:00",
      "message_count": 5
    },
    {
      "session_id": "uuid-2",
      "created_at": "2026-01-01T11:00:00",
      "message_count": 3
    }
  ]
}
```

#### /switch

**描述**: 切换到指定会话

**参数**:
- `<id>`: 会话ID

**示例**:
```
/switch uuid-2
```

**服务器响应**:
```json
{
  "success": true,
  "session_id": "uuid-2",
  "message": "已切换到会话 uuid-2"
}
```

#### /new

**描述**: 创建新会话

**参数**: 无

**示例**:
```
/new
```

**服务器响应**:
```json
{
  "success": true,
  "session_id": "uuid-new",
  "message": "已创建新会话"
}
```

#### /delete

**描述**: 删除指定会话

**参数**:
- `<id>`: 会话ID

**示例**:
```
/delete uuid-1
```

**服务器响应**:
```json
{
  "success": true,
  "message": "会话 uuid-1 已删除"
}
```

#### /history

**描述**: 查看历史记录

**参数**:
- `[count]`: 显示最近N条消息（可选，默认10）

**示例**:
```
/history
/history 20
```

**服务器响应**: 参见 HISTORY_RESPONSE (0x12)

#### /clear

**描述**: 清空当前会话历史

**参数**: 无

**示例**:
```
/clear
```

**服务器响应**:
```json
{
  "success": true,
  "message": "历史记录已清空"
}
```

## 错误处理

### 错误响应格式

```json
{
  "error": true,
  "error_type": "INVALID_PARAMETER",
  "error_code": 400,
  "message": "参数错误：文件大小超过10MB限制",
  "suggested_fix": "请上传小于10MB的文件",
  "retry_able": false
}
```

### 错误类型

| error_type | error_code | 描述 | retry_able |
|------------|------------|------|------------|
| INVALID_PARAMETER | 400 | 参数错误 | false |
| UNAUTHORIZED | 401 | 未授权 | false |
| FORBIDDEN | 403 | 禁止访问 | false |
| NOT_FOUND | 404 | 资源不存在 | false |
| CONFLICT | 409 | 状态冲突 | false |
| INTERNAL_ERROR | 500 | 服务器内部错误 | true |
| SERVICE_UNAVAILABLE | 503 | 服务不可用 | true |

## 测试场景

### 场景1: 连接测试

**输入**: 启动客户端，连接到 localhost:9999

**预期流程**:
1. 客户端发起TCP连接
2. 服务器接受连接
3. 服务器发送欢迎消息 (CHAT_TEXT)
4. 客户端显示欢迎消息

**预期结果**:
```
欢迎使用LLMChatAssistant智能运维助手！
已连接到服务器 localhost:9999
User>
```

### 场景2: 聊天测试

**输入**: "你好"

**预期流程**:
1. 客户端发送 CHAT_TEXT 消息
2. 服务器接收并调用智谱API
3. 服务器返回流式回复 (多个CHAT_TEXT + AGENT_THOUGHT)
4. 客户端显示回复

**预期结果**:
```
User> 你好
Agent> 你好！有什么我可以帮助你的吗？
```

### 场景3: 文件上传测试

**输入**: `/upload test.txt 测试文件`

**预期流程**:
1. 客户端读取文件内容
2. 客户端通过FILE_UPLOAD消息上传文件
3. 服务器保存文件并创建索引
4. 服务器返回文件元数据

**预期结果**:
```
文件上传成功！
  文件名: test.txt
  大小: 1024 字节
  已建立索引: 是
  文件ID: uuid-string
```

### 场景4: 文件下载测试

**输入**: "请把config.yaml文件发给我"

**预期流程**:
1. 客户端发送聊天消息
2. Agent调用file_download工具
3. 服务器发送DOWNLOAD_OFFER消息
4. 客户端显示下载提议
5. 用户确认下载
6. 通过RDT协议传输文件

**预期结果**:
```
Agent准备发送文件: config.yaml (1024 字节)
是否接受下载? (y/n): y
文件下载中... [██████████] 100%
文件已保存到: ./downloads/config.yaml
```

### 场景5: 会话管理测试

**输入**: `/sessions`, `/switch <id>`, `/new`, `/delete <id>`

**预期结果**:
```
User> /sessions
会话列表:
  1. uuid-1 (2026-01-01 10:00:00, 5条消息)
  2. uuid-2 (2026-01-01 11:00:00, 3条消息)

User> /switch uuid-2
已切换到会话 uuid-2

User> /new
已创建新会话 uuid-3

User> /delete uuid-1
会话 uuid-1 已删除
```

## 版本兼容性

### 协议版本检查

连接时，客户端和服务器交换协议版本号：

**客户端发送**:
```json
{
  "protocol_version": "1.0",
  "client_type": "cli"
}
```

**服务器响应**:
```json
{
  "protocol_version": "1.0",
  "server_status": "compatible"
}
```

**兼容性规则**:
- 主版本号相同：兼容
- 主版本号不同：不兼容，拒绝连接

---

**下一步**: 生成快速入门指南 ([quickstart.md](../quickstart.md))
