# 功能规范: CLI客户端重构与验证

**功能分支**: `001-cli-client-refactor`
**创建时间**: 2026-01-01
**状态**: 草稿
**输入**: 用户描述: "假定后端功能都已经全部验收通过，开始继续验证，开发，完善前端功能，从CLI开始，暂时不考虑desktop和web。CLI目前可能已经开发了一些功能。先校验现有功能的是否都正确实现，能否正确对接调用后端功能，然后为了后续拓展更多前端，还有客户端服务器端分别部署，可能客户端不适合放在src目录下，还需要考虑不同未来客户端的设计，需要重新考虑客户端的目录结构，在确认当前CLI前端现有功能都正确的情况下，开始进行重构，重构后再确认是否功能都正确。"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 全面验证现有CLI功能并识别问题 (优先级: P1)

作为开发者，我需要全面验证现有CLI客户端的所有功能，识别不符合要求或未正确调用后端API的问题，并创建详细的问题清单。

**优先级原因**: 这是整个重构工作的基础。只有先识别和记录所有问题，才能有针对性地修复，并为重构后的验证提供基线对比。

**独立测试**: 可以通过系统化地执行每个CLI功能，记录实际行为与预期行为的差异，生成问题报告和修复建议。

**验收场景**:

1. **给定** 后端服务正常运行并已验收通过，**当** 启动CLI客户端并连接，**那么** 客户端应成功连接，显示欢迎消息，无连接错误
2. **给定** 客户端已连接，**当** 发送聊天消息，**那么** 应正确调用后端聊天API并显示AI回复（包括流式输出）
3. **给定** 客户端已连接，**当** 使用 `/upload` 命令上传文件，**那么** 应正确调用后端文件上传API并成功上传
4. **给定** 服务器提供文件下载，**当** 客户端接收下载提议，**那么** 应正确调用后端下载API并完成文件传输
5. **给定** 客户端已连接，**当** 使用会话管理命令（/sessions, /switch, /new, /delete），**那么** 应正确调用后端会话API并管理会话
6. **给定** 客户端已连接，**当** 使用 `/model` 命令切换模型，**那么** 应正确调用后端模型切换API
7. **给定** 客户端已连接，**当** 使用 `/history` 和 `/clear` 命令，**那么** 应正确调用后端历史记录API
8. **给定** 测试过程中发现功能问题，**当** 记录问题，**那么** 每个问题应包含：问题描述、复现步骤、实际行为、预期行为、严重程度
9. **给定** 验证完成后，**当** 生成测试报告，**那么** 报告应包含：功能清单、测试结果、问题清单、修复建议

**测试报告结构要求**:
- 功能覆盖率：哪些功能已测试，哪些未测试
- 问题分类：API调用错误、UI显示问题、异常处理不当、性能问题等
- 严重程度分级：P0（阻塞功能）、P1（严重影响）、P2（一般影响）、P3（轻微影响）

---

### 用户故事 2 - 修复现有功能问题 (优先级: P1)

作为开发者，我需要修复用户故事1中识别的所有问题，确保所有CLI功能都正确调用后端API并符合要求。

**优先级原因**: 在重构之前修复现有问题可以确保重构的基线是稳定的，避免将已知问题带入重构后的代码。

**独立测试**: 可以通过针对每个修复的问题运行回归测试，验证问题已解决且未引入新问题。

**验收场景**:

1. **给定** 问题清单中的P0级别问题，**当** 修复并测试，**那么** 所有P0问题必须解决才能继续重构
2. **给定** 问题清单中的P1级别问题，**当** 修复并测试，**那么** 所有P1问题应在重构前解决
3. **给定** 修复后的代码，**当** 运行完整功能测试，**那么** 测试通过率应达到100%（所有功能正常）
4. **给定** 修复后的代码，**当** 检查日志，**那么** 不应有未处理的异常或错误日志
5. **给定** 修复后的代码，**当** 执行与后端API的集成测试，**那么** 所有API调用应返回预期结果
6. **给定** 修复完成后，**当** 更新测试报告，**那么** 报告应记录每个问题的修复状态和验证结果

**修复原则**:
- 优先修复阻塞功能和严重影响的问题
- 修复时应遵循项目章程（Python 3.11、uv管理、真实测试等）
- 每修复一个问题，立即编写测试用例防止回归
- 修复不得破坏其他已正常工作的功能

---

### 用户故事 3 - 重构客户端目录结构 (优先级: P1)

作为开发者，我需要将客户端代码从 `src/client/` 移动到独立的顶层目录 `clients/`，同时更新所有导入路径和配置，以支持未来多客户端开发和独立部署。

**优先级原因**: 这是架构重构的核心任务，为未来扩展Desktop、Web客户端奠定基础。

**独立测试**: 可以通过移动文件、更新导入路径后，运行导入测试和客户端启动测试，验证所有模块能正确导入和初始化。

**验收场景**:

1. **给定** 现有代码在 `src/client/` 下，**当** 创建新目录结构 `clients/cli/`，**那么** 所有客户端文件应正确移动到新位置
2. **给定** 文件已移动，**当** 更新所有Python导入路径，**那么** 所有模块应能正确导入，无ImportError
3. **给定** 新目录结构已创建，**当** 运行客户端入口程序，**那么** 客户端应能正常启动并连接服务器
4. **给定** 重构后，**当** 查看目录布局，**那么** 应清晰分离 `clients/`、`server/`、`shared/` 目录
5. **给定** 客户端在独立目录，**当** 测试依赖关系，**那么** 客户端应能独立打包（不依赖src目录中的服务器代码）
6. **给定** 重构后，**当** 更新配置文件和脚本，**那么** 所有路径引用应正确指向新位置

**期望的新目录结构**:

```
project-root/
├── clients/                    # 所有客户端代码（顶层目录）
│   ├── cli/                    # CLI客户端
│   │   ├── main.py            # CLI入口程序
│   │   ├── ui.py              # CLI界面渲染
│   │   ├── nplt_client.py     # NPLT协议客户端
│   │   ├── rdt_client.py      # RDT传输客户端
│   │   ├── __init__.py
│   │   └── tests/             # CLI客户端专用测试
│   ├── desktop/               # 未来Desktop客户端（预留目录）
│   └── web/                   # 未来Web客户端（预留目录）
├── server/                     # 服务器代码（从src/server移动到顶层）
│   ├── main.py                # 服务器入口
│   ├── http_server.py         # HTTP服务器
│   ├── agent.py               # Agent执行器
│   ├── nplt_server.py         # NPLT服务器
│   ├── rdt_server.py          # RDT服务器
│   └── tests/                 # 服务器专用测试
├── shared/                     # 共享代码（从src移动到顶层）
│   ├── protocols/             # 协议定义
│   │   ├── nplt.py            # NPLT协议
│   │   ├── rdt.py             # RDT协议
│   │   └── __init__.py
│   ├── utils/                 # 工具函数
│   │   ├── logger.py          # 日志工具
│   │   ├── config.py          # 配置管理
│   │   ├── path_validator.py  # 路径验证
│   │   └── __init__.py
│   ├── storage/               # 存储模块
│   │   ├── index_manager.py   # 索引管理
│   │   └── __init__.py
│   ├── llm/                   # LLM接口
│   │   └── __init__.py
│   └── tests/                 # 共享模块测试
├── src/                        # 保留用于纯服务器端工具
│   ├── tools/                 # 服务器端工具
│   │   ├── file_upload.py
│   │   ├── semantic_search.py
│   │   └── ...
│   └── __init__.py
├── tests/                      # 跨模块集成测试
├── config.yaml                 # 配置文件
├── requirements.txt            # 依赖管理
├── README.md                   # 项目文档
└── pyproject.toml             # 项目配置
```

---

### 用户故事 4 - 重构后功能完整性与回归测试 (优先级: P1)

作为开发者，我需要在重构后再次验证所有CLI功能，确保重构过程没有引入任何功能回归，并且所有之前修复的问题仍然已解决。

**优先级原因**: 这是验证重构成功的关键步骤。必须确保重构后的代码功能完整性和稳定性。

**独立测试**: 可以通过运行与用户故事1和2相同的测试套件，比较重构前后的测试结果，确保功能保持一致。

**验收场景**:

1. **给定** 重构后的代码，**当** 运行用户故事1中的所有测试场景，**那么** 所有测试应通过并得到与修复后相同的结果
2. **给定** 重构后的代码，**当** 执行完整的功能测试套件，**那么** 测试通过率应达到100%
3. **给定** 重构后的代码，**当** 检查日志文件，**那么** 不应出现导入错误、路径错误或模块找不到的异常
4. **给定** 重构后的代码，**当** 执行性能测试，**那么** 关键操作响应时间应与重构前相当（差异在10%以内）
5. **给定** 重构后的代码，**当** 验证之前修复的问题，**那么** 所有已修复的问题应保持已解决状态
6. **给定** 重构后的代码，**当** 运行所有单元测试和集成测试，**那么** 所有测试应通过
7. **给定** 重构完成后，**当** 生成对比报告，**那么** 报告应清晰展示重构前后的功能一致性

---

### 用户故事 5 - 建立多客户端扩展能力 (优先级: P2)

作为架构师，我需要确保重构后的架构能够方便地添加新的客户端类型（Desktop、Web），并通过清晰的代码组织降低未来开发成本。

**优先级原因**: 为未来扩展做准备。良好的架构设计可以降低后续开发的复杂度和工作量。

**独立测试**: 可以通过检查代码组织、依赖关系、模块划分，验证新客户端是否能够容易地接入系统。

**验收场景**:

1. **给定** 新的目录结构，**当** 查看 `clients/` 目录，**那么** 应看到CLI客户端在独立子目录，其他客户端类型预留了目录
2. **给定** 共享协议代码在 `shared/protocols/`，**当** 查看协议定义，**那么** 协议代码应该是客户端无关的，不依赖特定客户端实现
3. **给定** 服务器代码在 `server/`，**当** 查看服务器代码，**那么** 服务器应能够处理来自不同类型客户端的请求（通过协议识别）
4. **给定** 配置文件结构，**当** 查看配置，**那么** 应支持为不同客户端类型配置不同参数（端口、连接设置等）
5. **给定** 重构后的代码，**当** 评估添加新客户端的工作量，**那么** 相比重构前，预估工作量应降低至少30%
6. **给定** 重构后的架构，**当** 编写架构文档，**那么** 文档应清晰说明如何添加新客户端类型

---

### 用户故事 6 - 改善代码可维护性和文档 (优先级: P2)

作为开发者，我需要在重构过程中改善代码组织、更新文档、添加注释，提高代码的可维护性和可读性。

**优先级原因**: 良好的代码质量和文档是长期维护的基础，也是团队协作的前提。

**独立测试**: 可以通过代码审查、文档完整性和代码质量检查工具来验证。

**验收场景**:

1. **给定** 重构后的代码，**当** 阅读README和文档，**那么** 应能清楚了解新的目录结构和各模块职责
2. **给定** 重构后的代码，**当** 查看模块注释，**那么** 每个主要模块、类和函数应有清晰的中文文档字符串
3. **给定** 重构后的代码，**当** 查看测试文件，**那么** 测试应按照新的目录结构组织，并覆盖核心功能
4. **给定** 重构后的代码，**当** 查看.gitignore，**那么** 应正确排除客户端特定的临时文件和构建产物
5. **给定** 重构后的代码，**当** 生成架构文档，**那么** 文档应包含目录结构说明、模块依赖关系、扩展指南

---

### 边界情况

- **网络不稳定场景**: 当客户端在网络不稳定环境下操作（间歇性断网），重连机制是否正常工作？未完成的操作是否能恢复？
- **并发客户端场景**: 多个CLI客户端同时连接到服务器，是否会产生资源冲突或性能下降？服务器如何处理并发请求？
- **大文件传输边界**: 当传输接近10MB限制的文件时，系统是否稳定？内存使用是否合理？超时设置是否合适？
- **异常退出处理**: 当客户端强制退出（Ctrl+C、kill -9、系统崩溃）时，是否有适当的清理？状态是否会丢失？
- **配置文件错误**: 当配置文件缺失、格式错误或包含无效配置时，客户端是否提供清晰的错误提示和默认值？
- **协议版本不匹配**: 当客户端和服务器使用不同版本的协议时，系统如何处理？是否有版本协商机制？
- **文件名特殊字符**: 当上传文件名包含空格、中文、特殊字符或超长文件名时，系统是否正确处理？
- **会话状态同步**: 当客户端的会话状态与服务器不一致（如网络延迟导致的差异），如何检测和同步？
- **API调用失败**: 当后端API返回错误或超时时，客户端是否正确处理错误并给用户友好的提示？
- **内存泄漏**: 客户端长时间运行后，是否存在内存泄漏？如何验证？
- **路径遍历攻击**: 当文件路径包含 `../` 或其他遍历序列时，路径验证器是否正确阻止？

## 需求 *(必填)*

### 功能需求

**验证与修复需求**:

- **FR-001**: 系统必须能够全面验证现有CLI客户端的所有功能（12项核心功能）并识别问题
- **FR-002**: 系统必须生成详细的问题报告，包含问题描述、复现步骤、实际行为、预期行为、严重程度
- **FR-003**: 系统必须修复所有P0和P1级别的问题，确保核心功能正常工作
- **FR-004**: 系统必须为每个修复的问题编写测试用例，防止回归
- **FR-005**: 系统必须在修复后达到100%的功能测试通过率

**重构需求**:

- **FR-006**: 系统必须将客户端代码从 `src/client/` 移动到顶层目录 `clients/cli/`
- **FR-007**: 系统必须将服务器代码从 `src/server/` 移动到顶层目录 `server/`
- **FR-008**: 系统必须将共享代码（协议、工具、存储、LLM接口）从 `src/` 移动到 `shared/` 目录
- **FR-009**: 系统必须更新所有Python文件的导入路径，以适应新的目录结构
- **FR-010**: 系统必须确保客户端代码能够独立打包和部署，不依赖 `src/` 目录中的服务器代码
- **FR-011**: 系统必须为未来Desktop和Web客户端预留目录空间（`clients/desktop/`, `clients/web/`）
- **FR-012**: 系统必须更新配置文件、脚本和文档，以适应新的目录结构

**验证与测试需求**:

- **FR-013**: 系统必须在重构后再次验证所有CLI功能的正确性
- **FR-014**: 系统必须确保重构后的代码通过所有现有测试（单元测试、集成测试、端到端测试）
- **FR-015**: 系统必须执行回归测试，确保之前修复的问题仍然已解决
- **FR-016**: 系统必须执行性能测试，确保重构后关键操作响应时间变化在10%以内
- **FR-017**: 系统必须生成重构前后对比报告，展示功能一致性和性能对比

**文档与可维护性需求**:

- **FR-018**: 系统必须更新README文档，清晰说明新的目录结构和各模块职责
- **FR-019**: 系统必须为新的目录结构生成架构文档，包含模块依赖关系图和扩展指南
- **FR-020**: 系统必须确保所有主要模块、类和函数有清晰的中文文档字符串
- **FR-021**: 系统必须更新测试组织结构，按照新的目录结构安排测试文件
- **FR-022**: 系统必须更新.gitignore，正确排除客户端特定的临时文件和构建产物

**架构扩展性需求**:

- **FR-023**: 系统必须确保协议代码是客户端无关的，可被多种客户端类型复用
- **FR-024**: 系统必须确保服务器能够处理来自不同类型客户端的请求（通过协议识别）
- **FR-025**: 系统必须支持为不同客户端类型配置不同的参数（端口、连接设置等）
- **FR-026**: 系统必须降低添加新客户端的工作量，相比重构前减少至少30%

### 章程合规需求 (Constitution Compliance Requirements)

- **FR-027**: 系统必须使用 Python 3.11 运行
- **FR-028**: 系统必须使用 uv 管理虚拟环境和依赖
- **FR-029**: 所有日志必须写入 logs 文件夹,格式为纯文本 (.log)
- **FR-030**: 如涉及 LLM 调用,必须使用 zai-sdk 与智谱 AI 集成
- **FR-031**: 如涉及 LLM 功能,必须在启动前验证智谱 API key 已配置
- **FR-032**: 所有测试必须是真实测试,不允许使用 mock
- **FR-033**: 所有功能实现必须是真实的,不允许虚假实现
- **FR-034**: 所有用户回复、注释和文档必须使用中文
- **FR-035**: 错误消息、日志和 API 文档必须使用中文
- **FR-036**: 每完成一个开发阶段并通过真实完整测试后必须 git 提交一个版本
- **FR-037**: 测试不通过不允许提交代码
- **FR-038**: 提交消息必须清晰描述该阶段完成的工作和测试结果

#### 安全合规需求 (Security Compliance Requirements)

- **FR-039**: 如涉及文件访问,必须使用统一的路径白名单控制
- **FR-040**: 文件访问白名单配置必须存储在 config.yaml 的 file_access.allowed_paths 中
- **FR-041**: 路径验证器必须防止路径遍历攻击(如 ../ 规范化)
- **FR-042**: 必须维护黑名单模式以保护敏感文件(.env、.ssh/*、/etc/passwd 等)
- **FR-043**: 如涉及 RAG 功能,必须支持按需自动创建向量索引
- **FR-044**: 索引管理必须使用懒加载策略,避免重复索引
- **FR-045**: 向量索引必须持久化存储到 storage/vectors/ 目录
- **FR-046**: 索引创建必须验证文件类型(仅文本文件)和文件大小(默认最大 10MB)
- **FR-047**: 必须实现多层安全验证(白名单、黑名单、大小限制、内容类型验证)
- **FR-048**: 命令执行必须限制输出大小(默认最大 100KB)
- **FR-049**: 命令参数必须验证是否包含黑名单字符,防止命令注入
- **FR-050**: 所有文件访问、索引创建和工具调用必须记录审计日志
- **FR-051**: 文件访问被拒绝时必须返回明确的拒绝理由

### 关键实体

- **CLI客户端**: 位于 `clients/cli/` 目录下的命令行界面客户端实现，包括主程序、UI渲染、协议客户端等模块
- **服务器**: 位于 `server/` 目录下的服务器端代码，处理客户端请求、Agent执行、工具调用等
- **共享协议**: 位于 `shared/protocols/` 下的NPLT和RDT协议定义，被客户端和服务器共同使用
- **问题报告**: 记录现有CLI功能问题的文档，包含问题描述、复现步骤、实际行为、预期行为、严重程度、修复建议
- **测试报告**: 记录重构前后功能验证结果的文档，包含每个功能的测试状态、测试结果、性能对比
- **目录结构**: 项目的物理组织方式，从 `src/` 单一目录转变为 `clients/`、`server/`、`shared/` 分离的顶层目录
- **架构文档**: 描述新架构设计、模块依赖关系、扩展指南的文档

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 验证阶段必须100%覆盖所有12项核心CLI功能，并生成详细的问题报告
- **SC-002**: 修复阶段必须解决所有P0和P1级别的问题，功能测试通过率达到100%
- **SC-003**: 重构后的代码目录结构必须100%符合预设的新目录结构，无遗漏或错误放置的文件
- **SC-004**: 重构过程中，所有Python模块的导入路径必须100%正确更新，无导入错误
- **SC-005**: 重构后的代码必须通过所有现有单元测试和集成测试，测试通过率100%
- **SC-006**: 重构后的客户端必须能够独立启动并连接到服务器，无需依赖 `src/` 目录
- **SC-007**: 重构后的关键操作（连接、聊天、文件传输）响应时间与重构前相比差异应在10%以内
- **SC-008**: 重构后，添加新客户端（Desktop或Web）的预估工作量应降低至少30%
- **SC-009**: 重构后的代码文档覆盖率（模块注释和函数文档字符串）应达到80%以上
- **SC-010**: 重构完成后，必须在Git仓库中为每个主要阶段（验证、修复、重构、再验证）创建独立的提交记录
- **SC-011**: 重构后的目录结构必须在README和架构文档中清晰记录，与实际代码结构100%一致
- **SC-012**: 所有之前修复的问题在重构后必须保持已解决状态，无回归

## 假设

- **A-001**: 后端服务器功能已经全部验收通过，无需修改后端代码
- **A-002**: 现有CLI客户端可能存在功能缺陷或未正确调用后端API的问题，需要识别和修复
- **A-003**: 现有CLI客户端代码质量总体良好，可以在不重写核心逻辑的情况下进行重构
- **A-004**: 用户提到的"客户端不适合放在src目录下"是指为了更好的代码组织和未来扩展性
- **A-005**: "未来客户端"指的是至少包含CLI、Desktop和Web三种类型
- **A-006**: 重构过程中可以暂时停止其他开发工作，专注于客户端重构
- **A-007**: 项目使用Git进行版本控制，可以安全地创建新分支和合并代码
- **A-008**: 用户具有基本的Python开发环境配置能力（uv、Python 3.11等）
- **A-009**: 暂时不实现Desktop和Web客户端，但需要为它们预留架构空间和接口
- **A-010**: 现有的协议实现（NPLT和RDT）已经是客户端无关的，无需修改
- **A-011**: 重构后的客户端和服务器可以部署在同一台机器上，但架构上应支持分离部署
- **A-012**: 现有的测试套件可以适配新的目录结构，无需完全重写
- **A-013**: 用户接受在重构过程中可能有短期的功能不稳定期，但最终必须100%恢复功能
