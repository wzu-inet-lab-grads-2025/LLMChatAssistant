# 测试报告格式契约

**功能**: Agent功能全面验证测试
**版本**: 1.0
**日期**: 2025-12-29

## 概述

本契约定义了Agent功能验证测试的测试报告格式。所有测试报告必须遵循此格式，以确保一致性和可读性。

---

## 报告结构

每个测试报告是一个Markdown文件，包含以下章节：

```markdown
# 测试报告 TXXX: [测试名称]

## 测试信息
- 测试编号: TXXX
- 测试名称: [名称]
- 优先级: P1/P2/P3
- 执行时间: [时间戳]
- 状态: ✅ 通过 / ❌ 失败

## 测试输入
### 用户消息
```
[用户输入文本]
```

### 对话历史
[如果有上下文，列出之前的对话轮次]

## 工具链调用详情
[如果调用了工具，列出每个工具的详细信息]

## 最终结果
### Agent回复
```
[Agent的最终回复文本]
```

## 性能指标
- 总响应时间: [time]s
- 工具调用次数: [count]
- 工具执行总时间: [time]s
- 平均工具执行时间: [time]s

## 验收结果
- 场景1: [✅ 通过 / ❌ 失败] - [说明]
- 场景2: [✅ 通过 / ❌ 失败] - [说明]
...

## 测试结论
[通过/失败的判断依据和总结]
```

---

## 详细章节规范

### 1. 测试信息

必需字段：

| 字段 | 格式 | 示例 |
|------|------|------|
| 测试编号 | TXXX（XXX为3位数字）| T001 |
| 测试名称 | 简短描述 | 基础对话功能验证 |
| 优先级 | P1/P2/P3 | P1 |
| 执行时间 | ISO 8601格式 | 2025-12-29T12:34:56+08:00 |
| 状态 | ✅ 通过 或 ❌ 失败 | ✅ 通过 |

### 2. 测试输入

#### 2.1 用户消息

必须包含用户发送的原始消息，使用代码块格式：

```markdown
### 用户消息
```
你好
```
```

#### 2.2 对话历史（可选）

如果测试涉及多轮对话，列出之前的对话轮次：

```markdown
### 对话历史
**第1轮 (2025-12-29 12:34:56)**
- 用户: "我的名字是张三"
- Agent: "你好张三！很高兴认识你。"

**第2轮 (2025-12-29 12:35:10)**
- 用户: "我叫什么名字？"
- Agent: "你叫张三。"
```

### 3. 工具链调用详情

每个工具调用使用以下格式：

```markdown
### 工具调用 1
- **工具名称**: sys_monitor
- **调用时间**: 2025-12-29 12:34:57
- **参数**:
  ```json
  {
    "metric": "cpu"
  }
  ```
- **执行时间**: 0.52s
- **状态**: ✅ success / ❌ failed / ⏱️ timeout
- **结果**:
  ```
  CPU使用率: 45.2%
  CPU核心数: 8
  ...
  ```
```

#### 状态图标

- ✅ success - 工具执行成功
- ❌ failed - 工具执行失败
- ⏱️ timeout - 工具执行超时

#### 结果截断

如果工具结果超过200个字符，截断并添加"..."：

```markdown
- **结果**:
  ```
  文件列表（共100个文件）:
  - file1.txt
  - file2.txt
  ...
  [显示前20个，共100个]
  ```
```

### 4. 最终结果

#### 4.1 Agent回复

包含Agent的最终回复文本，使用代码块格式：

```markdown
### Agent回复
```
系统状态良好。CPU使用率为45.2%，内存使用率为62.3%，磁盘使用率为78.5%。所有指标均在正常范围内。
```
```

#### 4.2 完整对话（可选）

如果需要展示完整的对话流，包含中间的思考和工具调用：

```markdown
### 完整对话流
**用户**: 查看CPU使用率
**Agent思考**: [Thinking] 正在思考如何获取CPU使用率...
**Agent决策**: 调用 sys_monitor 工具
**工具结果**: CPU使用率: 45.2%
**Agent回复**: 当前CPU使用率为45.2%。
```

### 5. 性能指标

必需指标：

| 指标 | 格式 | 单位 | 说明 |
|------|------|------|------|
| 总响应时间 | 浮点数，保留2位小数 | 秒 | 从用户输入到Agent回复的总时间 |
| 工具调用次数 | 整数 | 次 | 工具被调用的总次数 |
| 工具执行总时间 | 浮点数，保留2位小数 | 秒 | 所有工具执行时间之和 |
| 平均工具执行时间 | 浮点数，保留2位小数 | 秒 | 工具执行总时间 / 工具调用次数 |
| LLM调用次数 | 整数 | 次 | LLM API被调用的总次数 |
| LLM调用总时间 | 浮点数，保留2位小数 | 秒 | 所有LLM调用时间之和 |

示例：

```markdown
## 性能指标
- 总响应时间: 1.82s
- 工具调用次数: 1
- 工具执行总时间: 0.52s
- 平均工具执行时间: 0.52s
- LLM调用次数: 2
- LLM调用总时间: 1.30s
```

#### 性能评估

如果性能指标符合成功标准，添加评估：

```markdown
### 性能评估
- ✅ 总响应时间 1.82s < 2.0s（符合SC-002）
- ✅ 工具执行时间 0.52s < 5.0s（符合SC-003）
```

### 6. 验收结果

每个验收场景使用以下格式：

```markdown
## 验收结果

### 场景1: 问候消息
- **状态**: ✅ 通过
- **给定**: Agent已初始化并连接到智谱API
- **当**: 用户发送问候消息"你好"
- **那么**: Agent应该返回友好的问候回复，不调用任何工具
- **实际**: Agent返回"你好！我是智能运维助手，有什么可以帮助你的吗？"，未调用工具
- **结论**: 符合预期

### 场景2: 自我介绍
- **状态**: ✅ 通过
- **给定**: Agent已初始化
- **当**: 用户询问简单问题"你是什么？"
- **那么**: Agent应该自我介绍，说明它是智能运维助手
- **实际**: Agent回复"我是基于大模型的智能运维助手，可以帮助你监控系统状态、执行命令、检索文档..."
- **结论**: 符合预期
```

#### 场景状态

- ✅ 通过 - 实际结果符合预期
- ❌ 失败 - 实际结果不符合预期
- ⚠️ 部分 - 部分符合预期（对于复杂场景）

### 7. 测试结论

总结测试的整体结果和判断依据：

```markdown
## 测试结论

### 总体评估
✅ **测试通过**

### 通过原因
1. 所有验收场景（3个）均通过
2. Agent能够正确进行基础对话，无需调用工具
3. 响应时间符合性能要求（1.82s < 2.0s）
4. 无错误或异常

### 成功标准验证
- ✅ SC-001: 基础对话功能正常
- ✅ SC-002: 响应时间符合要求
- ✅ SC-005: 测试报告完整

### 备注
本测试验证了Agent的基础对话能力，为后续复杂工具调用测试奠定了基础。
```

#### 失败情况

如果测试失败，详细说明失败原因：

```markdown
## 测试结论

### 总体评估
❌ **测试失败**

### 失败原因
1. 场景2未通过：Agent未能正确识别工具调用需求
2. 工具调用超时：工具执行时间6.2s > 5.0s限制

### 实际与预期对比
| 场景 | 预期 | 实际 | 结果 |
|------|------|------|------|
| 场景1 | 返回问候 | 返回问候 | ✅ |
| 场景2 | 调用sys_monitor | 未调用工具 | ❌ |
| 场景3 | 返回系统状态 | 返回"无法回答" | ❌ |

### 下一步建议
1. 调查Agent的思考逻辑，确保能够识别工具调用需求
2. 检查ToolTimeout配置，考虑是否需要调整超时限制
3. 修复问题后重新测试
```

---

## 文件命名规范

测试报告文件命名格式：

```
TXXX-[测试名称简写].md
```

示例：
- `T001-基础对话.md`
- `T002-系统监控.md`
- `T003-命令执行.md`
- `T009-模型切换.md`
- `T010-API降级.md`

文件存储位置：
```
specs/002-agent-validation-test/reports/
├── T001-基础对话.md
├── T002-系统监控.md
├── T003-命令执行.md
├── T004-测试报告.md
├── T005-多轮工具调用.md
├── T006-RAG检索.md
├── T007-对话上下文.md
├── T008-错误处理.md
├── T009-模型切换.md
└── T010-API降级.md
```

---

## 特殊情况处理

### 1. 无工具调用

如果测试未调用任何工具，工具链调用详情章节应说明：

```markdown
## 工具链调用详情
本次测试未调用任何工具。
```

### 2. 工具调用失败

如果工具调用失败，详细记录错误信息：

```markdown
### 工具调用 1
- **工具名称**: command_executor
- **调用时间**: 2025-12-29 12:34:57
- **参数**:
  ```json
  {
    "command": "cat",
    "args": ["/etc/passwd"]
  }
  ```
- **执行时间**: 0.01s
- **状态**: ❌ failed
- **错误信息**:
  ```
  路径访问被拒绝: 路径匹配禁止模式: /etc/passwd
  ```
```

### 3. 测试超时

如果测试超时（例如API调用时间过长）：

```markdown
## 测试执行异常
- **异常类型**: TimeoutError
- **超时时间**: 300.5s
- **说明**: 测试执行超过配置的超时限制（300s）
- **可能原因**:
  1. API响应缓慢
  2. 网络连接问题
  3. Agent陷入无限循环
```

### 4. 多轮工具调用

如果测试包含多轮工具调用（ReAct循环），在工具链调用详情章节添加汇总：

```markdown
## 工具链调用汇总
- 总轮数: 3
- 成功: 2
- 失败: 1
- 总执行时间: 1.56s

## 工具链调用详情
### 第1轮
- **工具**: sys_monitor
- **状态**: ✅ success
...

### 第2轮
- **工具**: command_executor
- **状态**: ✅ success
...

### 第3轮
- **工具**: rag_search
- **状态**: ❌ failed
- **错误**: 无可用索引
...
```

---

## 验证检查清单

生成测试报告后，使用以下检查清单验证格式：

- [ ] 报告包含所有必需章节（测试信息、输入、工具调用、结果、性能、验收、结论）
- [ ] 测试编号格式正确（TXXX）
- [ ] 优先级正确（P1/P2/P3）
- [ ] 状态图标正确（✅/❌/⏱️）
- [ ] 工具调用包含所有必需字段（名称、时间、参数、执行时间、状态、结果）
- [ ] 性能指标包含所有必需字段（总响应时间、工具调用次数等）
- [ ] 验收场景每个都有通过/失败状态
- [ ] 测试结论包含总体评估和判断依据
- [ ] 文件名符合命名规范（TXXX-[简写].md）
- [ ] 文件存储在正确位置（specs/002-agent-validation-test/reports/）

---

## 示例报告

完整的示例报告请参考：
- [specs/002-agent-validation-test/reports/T001-基础对话.md](../reports/T001-基础对话.md)（将在测试执行后生成）

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0 | 2025-12-29 | 初始版本 |
