# 功能规范: 文件操作工具集成到 Agent

**功能分支**: `003-file-tools-integration`
**创建时间**: 2025-12-30
**状态**: 草稿
**输入**: 用户描述: "实现文件操作工具集成到Agent，支持文件上传、下载、语义检索和串行工具调用"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 文件上传功能 (优先级: P1)

用户可以通过聊天界面将本地文件上传给 Agent，以便 Agent 可以分析文件内容或基于文件内容回答问题。

**优先级原因**: 这是文件操作的基础功能，用户需要先上传文件才能进行后续的分析和检索操作。没有上传功能，其他文件操作都无法进行。

**独立测试**: 用户可以独立上传文件并验证 Agent 接收到文件，无需依赖其他功能。测试价值：验证文件传输通道的可用性。

**验收场景**:

1. **给定** Agent 已启动，**当** 用户通过客户端上传一个文本文件，**那么** Agent 接收文件并确认文件已保存，返回文件元数据（文件名、大小、存储路径）
2. **给定** 用户上传一个 5MB 的文本文件，**当** 上传完成，**那么** 文件成功保存且系统提示文件已自动建立索引可用于检索
3. **给定** 用户尝试上传一个 15MB 的文件，**当** 上传请求发出，**那么** 系统拒绝上传并提示文件大小超过限制（最大 10MB）
4. **给定** 用户尝试上传一个可执行文件（.exe），**当** 上传请求发出，**那么** 系统拒绝上传并提示仅支持文本文件类型

---

### 用户故事 2 - 文件下载功能 (优先级: P1)

用户可以要求 Agent 将服务器上的文件发送到用户本地，方便用户获取需要的文档或配置文件。

**优先级原因**: 这是文件操作的另一个核心功能，用户需要能够从服务器获取文件。配合上传功能形成完整的文件传输闭环。

**独立测试**: 用户可以请求下载一个已存在的文件，并验证文件成功传输到本地。测试价值：验证服务器到客户端的文件传输能力。

**验收场景**:

1. **给定** Agent 已启动且服务器上存在文件 `/docs/config.yaml`，**当** 用户说"把配置文件发给我"，**那么** Agent 向用户发送下载提议，包含文件名和大小
2. **给定** Agent 发送了下载提议，**当** 用户确认接受下载，**那么** 文件通过文件传输协议发送到用户本地
3. **给定** 用户请求下载一个不存在的文件，**当** 请求发出，**那么** Agent 返回明确的错误提示"文件不存在"并建议可用的文件
4. **给定** 用户请求下载路径包含 `..` 的文件（如 `../../etc/passwd`），**当** 请求发出，**那么** Agent 拒绝下载并提示路径不安全（路径遍历保护）

---

### 用户故事 3 - 语义检索文件功能 (优先级: P1)

用户可以用自然语言描述要查找的文件内容，Agent 通过语义检索在已索引的文件中搜索相关内容并返回匹配的文件。

**优先级原因**: 这是智能文件操作的核心能力，让用户无需记住具体文件名就能找到需要的文件，大幅提升用户体验。

**独立测试**: 用户可以上传几个测试文件，然后用自然语言搜索文件内容，验证 Agent 能够找到正确的文件。测试价值：验证语义检索的准确性。

**验收场景**:

1. **给定** 已上传并索引了包含"数据库配置"内容的文件，**当** 用户问"有没有关于数据库配置的文档？"，**那么** Agent 调用语义检索工具并返回相关文件的路径和匹配的内容片段
2. **给定** 已索引了多个文档，**当** 用户询问"昨天讨论的性能问题在哪里记录？"，**那么** Agent 返回包含相关内容的文件列表，按相似度排序
3. **给定** 没有已索引的文件，**当** 用户询问文件内容，**那么** Agent 提示"当前没有已索引的文件，请先上传文件"
4. **给定** 用户询问的内容在索引文件中不存在，**当** 检索完成，**那么** Agent 返回"未找到相关内容"并提供可能的替代搜索建议

---

### 用户故事 4 - 串行工具调用功能 (优先级: P2)

用户可以通过一次请求触发多个工具的串行调用，例如先搜索文件再下载，Agent 能够自动完成多步骤操作。

**优先级原因**: 这是高级功能，显著提升用户体验和操作效率。但依赖于前三个功能，所以是 P2 优先级。

**独立测试**: 用户可以发出"把关于性能分析的报告发给我"的请求，验证 Agent 先执行文件搜索再执行文件下载。测试价值：验证 ReAct 循环的串行工具调用能力。

**验收场景**:

1. **给定** 已索引了多个文档，**当** 用户说"把关于性能分析的报告发给我"，**那么** Agent 先调用语义检索工具找到文件，再调用文件下载工具将文件发送给用户
2. **给定** 已索引了文档，**当** 用户说"把昨天的配置文件发给我"，**那么** Agent 先执行语义检索定位文件，然后自动执行下载流程
3. **给定** 检索工具找到了多个匹配文件，**当** Agent 执行串行调用，**那么** Agent 询问用户需要下载哪个文件（智能决策）
4. **给定** 检索工具未找到文件，**当** Agent 执行串行调用，**那么** Agent 跳过下载步骤并告知用户未找到文件（错误处理）

---

### 用户故事 5 - 文件管理功能 (优先级: P3)

用户可以查看已上传的文件列表、删除不需要的文件、重新索引文件等管理操作。

**优先级原因**: 这是辅助功能，提升用户体验但不是核心必需功能。核心文件操作（上传、下载、检索）已能满足基本需求。

**独立测试**: 用户可以查看文件列表、删除文件并验证操作结果。测试价值：验证文件生命周期管理能力。

**验收场景**:

1. **给定** 用户已上传了多个文件，**当** 用户说"查看已上传的文件"，**那么** Agent 返回文件列表，包含文件名、大小、上传时间
2. **给定** 存在不需要的文件，**当** 用户说"删除临时文件 tmp.log"，**那么** Agent 删除文件并返回确认消息
3. **给定** 用户重新上传了同名文件，**当** 上传完成，**那么** 系统更新文件内容并重新建立索引

---

### 边界情况

- **并发上传**: 当两个用户同时上传文件时会发生什么？系统应该支持并发文件上传并确保文件不会互相覆盖
- **网络中断**: 当文件传输过程中网络中断时会发生什么？系统应该检测传输失败并返回明确的错误消息，支持断点续传或重新上传
- **文件编码异常**: 当上传的文本文件包含特殊编码或损坏时会发生什么？系统应该检测编码问题并尝试修复，或明确提示用户文件格式错误
- **索引失败**: 当文件内容无法建立向量索引时（如 API 调用失败）会发生什么？系统应该记录错误并允许文件手动重新索引
- **磁盘空间不足**: 当服务器存储空间不足时会发生什么？系统应该在上传前检查可用空间并提前拒绝上传，避免部分写入
- **文件名冲突**: 当上传同名文件时会发生什么？系统应该提示用户选择覆盖、重命名或取消操作

## 需求 *(必填)*

### 功能需求

#### 文件上传需求

- **FR-001**: 系统必须允许用户通过聊天界面上传本地文件到 Agent 服务器
- **FR-002**: 系统必须验证文件类型，仅支持文本文件（.txt、.md、.yaml、.json、.py、.js 等）
- **FR-003**: 系统必须限制文件大小不超过 10MB，超过限制的文件必须被拒绝并提示用户
- **FR-004**: 系统必须在文件上传成功后自动为文件建立向量索引，使其可用于语义检索
- **FR-005**: 系统必须在文件上传完成后返回文件元数据（文件名、大小、存储路径、上传时间）
- **FR-006**: 系统必须在上传过程中显示进度，让用户了解传输状态

#### 文件下载需求

- **FR-007**: 系统必须允许用户请求 Agent 将服务器文件发送到本地
- **FR-008**: 系统必须在发送文件前向用户发送下载提议，包含文件名和大小
- **FR-009**: 系统必须在用户确认接受后才发送文件数据
- **FR-010**: 系统必须验证文件路径在白名单内，拒绝下载白名单外的文件（安全保护）
- **FR-011**: 系统必须拒绝包含路径遍历字符（`..`）的下载请求，防止安全攻击
- **FR-012**: 系统必须在文件不存在时返回明确的错误提示，并提供可用文件列表

#### 语义检索需求

- **FR-013**: 系统必须允许用户用自然语言描述要查找的文件内容
- **FR-014**: 系统必须在已索引的文件中进行语义检索，返回相关文件列表
- **FR-015**: 系统必须返回匹配文件的内容片段和相似度评分，帮助用户判断相关性
- **FR-016**: 系统必须按相似度对检索结果排序，最相关的文件排在前面
- **FR-017**: 系统必须在没有已索引文件时明确提示用户，并建议先上传文件
- **FR-018**: 系统必须在未找到相关内容时返回友好的提示，并提供搜索建议

#### 串行工具调用需求

- **FR-019**: 系统必须支持在一次对话中调用多个工具（如先检索再下载）
- **FR-020**: 系统必须能够将前一个工具的结果作为后一个工具的输入（如检索结果中的文件路径用于下载）
- **FR-021**: 系统必须在每个工具调用后向用户显示进度，让用户了解执行状态
- **FR-022**: 系统必须在工具调用失败时优雅处理，尝试其他方法或提示用户
- **FR-023**: 系统必须在多步骤操作中维护上下文，确保后续操作能够引用前面的结果
- **FR-024**: 系统必须限制单次对话中的工具调用次数不超过 5 次，防止无限循环

#### 文件管理需求

- **FR-025**: 系统必须允许用户查看已上传的文件列表，包含文件名、大小、上传时间
- **FR-026**: 系统必须允许用户删除不需要的文件
- **FR-027**: 系统必须在删除文件时同步删除相关的向量索引
- **FR-028**: 系统必须在同名文件上传时提示用户选择覆盖、重命名或取消

#### Agent 集成需求

- **FR-029**: 系统必须将文件上传、下载、语义检索功能作为工具集成到 ReAct Agent 中
- **FR-030**: 系统必须在 Agent 的工具决策逻辑中识别文件操作相关的用户请求
- **FR-031**: 系统必须更新 Agent 的提示词，包含文件工具的使用说明和示例
- **FR-032**: 系统必须记录所有文件操作工具的调用日志（工具名、参数、结果、执行时间）

### 章程合规需求 (Constitution Compliance Requirements)

- **FR-033**: 系统必须使用 Python 3.11 运行
- **FR-034**: 系统必须使用 uv 管理虚拟环境和依赖
- **FR-035**: 所有日志必须写入 logs 文件夹，格式为纯文本 (.log)
- **FR-036**: 如涉及 LLM 调用，必须使用 zai-sdk 与智谱 AI 集成
- **FR-037**: 如涉及 LLM 功能，必须在启动前验证智谱 API key 已配置
- **FR-038**: 所有测试必须是真实测试，不允许使用 mock
- **FR-039**: 所有功能实现必须是真实的，不允许虚假实现
- **FR-040**: 所有用户回复、注释和文档必须使用中文
- **FR-041**: 错误消息、日志和 API 文档必须使用中文
- **FR-042**: 每完成一个开发阶段并通过真实完整测试后必须 git 提交一个版本
- **FR-043**: 测试不通过不允许提交代码
- **FR-044**: 提交消息必须清晰描述该阶段完成的工作和测试结果

#### 安全合规需求 (Security Compliance Requirements)

- **FR-045**: 文件访问必须使用统一的路径白名单控制
- **FR-046**: 文件访问白名单配置必须存储在 config.yaml 的 file_access.allowed_paths 中
- **FR-047**: 路径验证器必须防止路径遍历攻击（如 `../` 规范化）
- **FR-048**: 必须维护黑名单模式以保护敏感文件（.env、.ssh/*、/etc/passwd 等）
- **FR-049**: 如涉及 RAG 功能，必须支持按需自动创建向量索引
- **FR-050**: 索引管理必须使用懒加载策略，避免重复索引
- **FR-051**: 向量索引必须持久化存储到 storage/vectors/ 目录
- **FR-052**: 索引创建必须验证文件类型（仅文本文件）和文件大小（默认最大 10MB）
- **FR-053**: 必须实现多层安全验证（白名单、黑名单、大小限制、内容类型验证）
- **FR-054**: 文件上传必须验证文件类型和大小，防止恶意文件上传
- **FR-055**: 文件下载必须验证路径白名单，防止未授权文件访问
- **FR-056**: 所有文件访问、索引创建和工具调用必须记录审计日志
- **FR-057**: 文件访问被拒绝时必须返回明确的拒绝理由

### 关键实体

- **上传文件 (UploadedFile)**: 代表用户上传的文件，包含文件元数据（唯一 ID、原始文件名、文件大小、内容类型、存储路径、上传时间、关联的向量索引 ID）
- **文件下载提议 (DownloadOffer)**: 代表 Agent 向用户发送的文件下载提议，包含文件 ID、文件名、文件大小，需要用户确认后才会传输实际文件数据
- **文件检索结果 (FileSearchResult)**: 代表语义检索的匹配结果，包含文件路径、文件名、匹配的内容片段、相似度评分、文件位置信息
- **工具调用上下文 (ToolCallContext)**: 代表串行工具调用的上下文信息，包含之前的工具调用结果、当前步骤、用户原始请求

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户可以在 30 秒内完成一个 5MB 文件的上传（包含索引创建时间）
- **SC-002**: 用户可以在 20 秒内完成一个 5MB 文件的下载（从请求到本地接收完成）
- **SC-003**: 语义检索在已索引文件中查询时，90% 的请求在 3 秒内返回相关结果
- **SC-004**: 串行工具调用（检索+下载）在 10 秒内完成，用户感知流畅
- **SC-005**: 90% 的用户在首次尝试时成功完成文件上传操作
- **SC-006**: 90% 的用户在首次尝试时成功完成文件下载操作
- **SC-007**: 语义检索返回的相关文件中，用户确认的相关性准确率 ≥ 80%
- **SC-008**: 文件操作错误（如路径越界、类型不支持）时，100% 返回明确的中文错误提示
- **SC-009**: 所有文件操作（上传、下载、检索）100% 记录审计日志，包含操作时间、用户、文件路径、操作结果
- **SC-010**: 系统支持至少 10 个用户同时上传文件，且上传成功率 ≥ 95%

## 假设与约束

### 假设

- 用户通过现有的聊天客户端与 Agent 交互，客户端已支持文件上传下载功能（NPLT 协议已实现 FILE_DATA、FILE_METADATA 消息类型）
- 服务器磁盘空间充足（至少 1GB 可用空间），能够存储用户上传的文件和向量索引
- 用户使用的是现代浏览器或客户端，支持大文件传输（通过 NPLT 协议的分块传输）
- 网络连接稳定，文件传输过程中不会频繁中断

### 约束

- 文件大小限制为 10MB，受限于向量化 API 的输入限制和存储成本
- 仅支持文本文件类型，二进制文件（图片、视频等）不在本功能范围内
- 语义检索依赖于智谱 API 的 Embedding 服务，API 调用失败会影响检索功能
- 文件存储在本地文件系统，不支持分布式存储或云存储集成
- ReAct 循环限制最多 5 轮工具调用，复杂的多步骤操作可能无法完成

## 依赖关系

### 依赖的功能

- **ReAct Agent 框架**: 文件工具需要集成到现有的 ReAct Agent 中（src/server/agent.py）
- **NPLT 协议**: 文件传输依赖于现有的 NPLT 协议（DOWNLOAD_OFFER、FILE_DATA、FILE_METADATA 消息类型）
- **向量存储系统**: 语义检索依赖于现有的 VectorStore 和 IndexManager（src/storage/vector_store.py、src/storage/index_manager.py）
- **路径验证器**: 文件安全访问依赖于现有的 PathValidator（src/utils/path_validator.py）

### 被依赖的功能

- 本功能是独立的文件操作能力，不阻塞其他功能的开发
- 后续可能基于本功能扩展更多文件操作（如文件编辑、文件版本管理等）

## 范围界定

### 包含在范围内

- 文件上传到服务器并建立索引
- 文件从服务器发送到客户端
- 基于自然语言的语义文件检索
- 串行工具调用（如先检索再下载）
- 基本的文件管理（列表、删除、重新索引）
- 文件安全验证（路径白名单、类型检查、大小限制）

### 不包含在范围内

- 文件编辑功能（如在线编辑器）
- 文件版本管理（如 Git 集成）
- 文件共享和权限管理（多用户场景）
- 云存储集成（如 AWS S3、Azure Blob）
- 二进制文件处理（图片、视频等）
- 文件预览功能（在聊天界面中预览文件内容）
- 断点续传或分块上传优化
- 文件加密和解密
