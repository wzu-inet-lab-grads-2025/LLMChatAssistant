

# LLMChatAssistant æ™ºèƒ½ç½‘ç»œè¿ç»´åŠ©æ‰‹ - éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦


## 1. é¡¹ç›®æ¦‚è¿°ä¸çº¦æŸ

### 1.1 é¡¹ç›®ç›®æ ‡
æ„å»ºä¸€ä¸ªè¿è¡Œåœ¨ç”¨æˆ·æœ¬åœ°ç»ˆç«¯çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œé€šè¿‡ TCP é•¿è¿æ¥ä¸è¿œç¨‹æœåŠ¡å™¨é€šä¿¡ã€‚ç³»ç»Ÿéœ€åœ¨å‘½ä»¤è¡Œä¸­æä¾›ç±» IDE çš„æ²‰æµ¸å¼ä½“éªŒï¼Œå¹¶è‡ªä¸»å®ç°å¯é æ–‡ä»¶ä¼ è¾“åè®®ã€‚

### 1.2 æ ¸å¿ƒçº¦æŸ
1.  **å•ä¸€å®¢æˆ·ç«¯**: ä»…å®ç° **CLI**ï¼Œç§»é™¤ Web/Desktopã€‚
2.  **æ¨¡å‹é™åˆ¶**: æ™ºè°±AI (`glm-4-flash`, `embedding-3-pro`)ã€‚
3.  **æ–‡ä»¶é™åˆ¶**: ä»…æ”¯æŒçº¯æ–‡æœ¬æ–‡ä»¶ã€‚
4.  **ç¯å¢ƒé™åˆ¶**: å®¢æˆ·ç«¯ä½äº NAT åï¼Œéœ€ä¸»åŠ¨è¿æ¥æœåŠ¡å™¨ TCP/UDP ç«¯å£ã€‚

---

## 2. CLI å®¢æˆ·ç«¯äº¤äº’é€»è¾‘è¯¦è§£ (The Rich TUI)

å®¢æˆ·ç«¯åŸºäº Python `Rich` åº“æ„å»ºï¼Œé‡‡ç”¨ **Prompt -> Spinner -> Streaming -> TUI** çš„çŠ¶æ€æµè½¬ã€‚

### 2.1 å¯åŠ¨ä¸è¿æ¥é˜¶æ®µ
*   **è§†è§‰æ•ˆæœ**:
    ```text
    â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    â”‚  ğŸš€ LLM Chat Assistant (CLI) - v1.0                      â”‚
    â”‚  Backend: TCP/NPLT | Transfer: UDP/RDT | AI: GLM-4       â”‚
    â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    [   INFO   ] Resolving remote host 123.45.67.89...
    [   INFO   ] Connecting to TCP Port 9999...
    [ SUCCESS  ] Session Established. Heartbeat Interval: 90s.
    
    (æ¸…å±ï¼Œè¿›å…¥ä¸»ç•Œé¢)
    ```

### 2.2 ä¸»å¯¹è¯äº¤äº’ (Normal Chat Flow)

#### **Step 1: ç”¨æˆ·è¾“å…¥**
*   **Prompt æ ·å¼**: ä½¿ç”¨åŒè¡Œæç¤ºç¬¦ï¼Œæ¸…æ™°åŒºåˆ†æœ¬åœ°ç¯å¢ƒã€‚
    ```text
    â•­â”€ [User] @ [Local-Laptop] â”€â”€ (PWD: /Users/dev/downloads)
    â•°â”€> å¸®æˆ‘æ£€æŸ¥ä¸€ä¸‹æœåŠ¡å™¨å†…å­˜ï¼Œé¡ºä¾¿çœ‹çœ‹ logs ç›®å½•ä¸‹æœ‰æ²¡æœ‰é”™è¯¯æ—¥å¿—ã€‚
    ```

#### **Step 2: æ€è€ƒçŠ¶æ€ (The Thinking Phase)**
*   **è§¦å‘æ¡ä»¶**: ç”¨æˆ·å›è½¦å‘é€åï¼Œæ”¶åˆ°åç«¯ NPLT `AGENT_THOUGHT` åŒ…ä¹‹å‰ã€‚
*   **è§†è§‰æ•ˆæœ**: åº•éƒ¨å›ºå®šæ æ˜¾ç¤º Spinnerã€‚
    ```text
    â ‹ [Agent] æ­£åœ¨åˆ†ææ„å›¾...
    ```

#### **Step 3: å·¥å…·æ‰§è¡Œåé¦ˆ (Tool Feedback)**
*   **è§¦å‘æ¡ä»¶**: æ”¶åˆ° NPLT `AGENT_THOUGHT` åŒ…ã€‚
*   **é€»è¾‘**: åç«¯æ¨é€ä¸­é—´çŠ¶æ€ï¼Œå‰ç«¯å¿…é¡»å®æ—¶åˆ·æ–°ï¼Œè®©ç”¨æˆ·æ„Ÿåˆ°"æ´»ç€"ã€‚
*   **è§†è§‰æ•ˆæœ**:
    ```text
    â ™ [Tool: sys_monitor] Reading system metrics...
    ```
    *(1ç§’åå˜æ›´ä¸º)*
    ```text
    â ™ [Tool: file_search] Searching "error.log" in /var/logs...
    ```

#### **Step 4: æµå¼å“åº” (Streaming Response)**
*   **è§¦å‘æ¡ä»¶**: æ”¶åˆ° NPLT `CHAT_TEXT` åŒ…ã€‚
*   **é€»è¾‘**: 
    1.  åœæ­¢ Spinnerã€‚
    2.  æ‰“å° AI å¤´åƒ `ğŸ¤– [Assistant]:`ã€‚
    3.  æ¥æ”¶ 255 å­—èŠ‚çš„ Chunkï¼Œæ‹¼æ¥åˆ° Bufferï¼Œå®æ—¶åˆ·æ–° Markdown æ¸²æŸ“å™¨ã€‚
*   **è§†è§‰æ•ˆæœ**:
    ```markdown
    ğŸ¤– [Assistant]:
    
    **1. ç³»ç»Ÿå†…å­˜çŠ¶æ€**
    - æ€»å†…å­˜: 16GB
    - å·²ä½¿ç”¨: 8.5GB (53%)
    
    **2. æ—¥å¿—æ£€æŸ¥**
    åœ¨ `logs/` ç›®å½•ä¸‹å‘ç°äº† `error.log` (2.5MB)ã€‚
    
    æ˜¯å¦éœ€è¦ä¸‹è½½è¯¥æ—¥å¿—æ–‡ä»¶ï¼Ÿ
    ```

### 2.3 æ–‡ä»¶ä¸Šä¼  (Slash Command)
*   **è¾“å…¥**: `/upload config.yaml`
*   **é€»è¾‘**:
    1.  Client æ£€æŸ¥æœ¬åœ°è·¯å¾„æ˜¯å¦å­˜åœ¨ã€‚
    2.  è¯»å–æ–‡ä»¶å†…å®¹ã€‚
    3.  **UI**: æ˜¾ç¤ºè¿›åº¦æ¡ (Rich Progress)ã€‚
    4.  **Network**: å°†å†…å®¹åŒ…è£…ä¸º Prompt å‘é€ç»™åç«¯ (`User uploaded file <content>...`)ã€‚
*   **è§†è§‰æ•ˆæœ**:
    ```text
    [â†‘] Uploading config.yaml (1.2KB)...
    [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100% Done
    
    [System] æ–‡ä»¶å·²å‘é€å¹¶å»ºç«‹ç´¢å¼•ã€‚
    ```

### 2.4 RDT æ–‡ä»¶ä¸‹è½½ (The Visualized TUI)
è¿™æ˜¯äº¤äº’æœ€å¤æ‚çš„éƒ¨åˆ†ï¼Œéœ€è¦æ¥ç®¡å±å¹•æ§åˆ¶æƒã€‚

*   **è§¦å‘**: åç«¯å‘é€ `DOWNLOAD_OFFER` åŒ…ã€‚
*   **UI è¯¢é—®**:
    ```text
    [?] AI å‡†å¤‡å‘é€æ–‡ä»¶: error.log (2.5MB)
        è¾“å…¥ 'y' å¼€å§‹ UDP å¯é ä¼ è¾“ > y
    ```
*   **ä¼ è¾“è§†å›¾**: æ¸…å±æˆ–åœ¨åº•éƒ¨å¼¹å‡ºç‹¬ç«‹é¢æ¿ã€‚
    ```text
    â•­â”€â”€ RDT Reliable Transfer (UDP Mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    â”‚ File: error.log               Size: 2.5 MB               â”‚
    â”‚ Local: ./downloads/error.log  Remote: 123.45.67.89:9999  â”‚
    â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    
    Window State (N=5):
    [101] [102] [103] [104] [105] 
     [âœ”]   [âœ”]   [S]   [S]   [.]
    
    Legend: [âœ”]Acked  [S]Sent  [!]Lost  [.]Wait
    
    Transfer Progress:
    [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 45% 
    
    Stats: Speed 1.2 MB/s | Retransmissions: 12 | RTT: 45ms
    ```

---

## 3. Agent ä¸å·¥å…·è°ƒç”¨é€»è¾‘è¯¦è§£ (Backend L3/L4)

åç«¯ Agent ä¸ä½¿ç”¨ LangChainï¼Œè€Œæ˜¯é€šè¿‡ **åŸç”Ÿ Python ä»£ç ** å®ç° "ReAct" (Reasoning + Acting) å¾ªç¯ã€‚

### 3.1 Agent æ ¸å¿ƒå¾ªç¯ (The Orchestrator)

è¿™æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ L3 å±‚çš„ `while` å¾ªç¯ï¼š

```python
def run_agent_loop(user_input, history, client_sock):
    # 1. æ„å»ºä¸Šä¸‹æ–‡
    messages = history + [{"role": "user", "content": user_input}]
    
    current_turn_count = 0
    MAX_TURNS = 5  # é˜²æ­¢æ— é™é€’å½’è°ƒç”¨å·¥å…·
    
    while current_turn_count < MAX_TURNS:
        # 2. è°ƒç”¨ LLM (GLM-4-Flash)
        # tools åˆ—è¡¨åŒ…å«æ‰€æœ‰å¯ç”¨å‡½æ•°çš„ JSON Schema
        response = client.chat.completions.create(
            model="glm-4-flash",
            messages=messages,
            tools=TOOL_DEFINITIONS
        )
        msg = response.choices[0].message
        
        # 3. åˆ¤æ–­: LLM æ˜¯å¦æƒ³è°ƒç”¨å·¥å…·?
        if not msg.tool_calls:
            # Case A: ä¸éœ€è¦å·¥å…·ï¼Œç›´æ¥å›å¤ç”¨æˆ·
            # é€šè¿‡ NPLT æµå¼å‘é€ msg.content
            nplt_stream_send(client_sock, msg.content)
            # æ›´æ–°å†å²å¹¶é€€å‡º
            history.append({"role": "assistant", "content": msg.content})
            return

        # Case B: éœ€è¦è°ƒç”¨å·¥å…·
        messages.append(msg) # å°† AI çš„æ€è€ƒåŠ å…¥å†å²
        
        for tool_call in msg.tool_calls:
            func_name = tool_call.function.name
            args = json.loads(tool_call.function.arguments)
            call_id = tool_call.id
            
            # 4. æ¨é€çŠ¶æ€ç»™å‰ç«¯ (NPLT Type 0x0A)
            # è®© CLI æ˜¾ç¤º "æ­£åœ¨æ‰§è¡Œ xxx..."
            nplt_send_packet(client_sock, AGENT_THOUGHT, {
                "tool": func_name,
                "status": "executing",
                "desc": f"Running {func_name}..."
            })
            
            # 5. æ‰§è¡Œå·¥å…· (L4 Layer Dispatch)
            # å¿…é¡»æ•è·å¼‚å¸¸ï¼Œé˜²æ­¢å·¥å…·æŠ¥é”™å¯¼è‡´ Agent å´©æºƒ
            try:
                result_str = execute_tool_logic(func_name, args)
            except Exception as e:
                result_str = f"Error: {str(e)}"
                
            # 6. å°†ç»“æœå›å¡«è¿›ä¸Šä¸‹æ–‡
            messages.append({
                "role": "tool",
                "tool_call_id": call_id,
                "content": result_str
            })
            
        current_turn_count += 1
```

### 3.2 å·¥å…·å®ç°ç»†èŠ‚ (L4 Capabilities)

#### **Tool 1: `tool_exec_cmd` (å®‰å…¨å‘½ä»¤æ‰§è¡Œ)**
*   **è®¾è®¡é€»è¾‘**:
    *   **ç™½åå•æ£€æŸ¥**: åœ¨æ‰§è¡Œå‰ï¼Œè§£æ `command` å­—ç¬¦ä¸²ï¼Œæå–ç¬¬ä¸€ä¸ªå•è¯ (command binary)ã€‚å¿…é¡»åœ¨ `['ls', 'cat', 'grep', 'head', 'tail', 'ps', 'pwd', 'whoami', 'df', 'free']` åˆ—è¡¨ä¸­ã€‚
    *   **é»‘åå•å‚æ•°**: æ£€æŸ¥æ˜¯å¦åŒ…å« `&` (åå°), `;` (å¤šå‘½ä»¤), `>` (é‡å®šå‘), `|` (ç®¡é“ - è§†æƒ…å†µå¼€æ”¾ï¼Œå»ºè®®ç®€å•èµ·è§ä»…å…è®¸å•ç®¡é“)ã€‚
    *   **è¶…æ—¶æ§åˆ¶**: ä½¿ç”¨ `subprocess.run(..., timeout=5)`ï¼Œé˜²æ­¢å‘½ä»¤å¡æ­»ã€‚
*   **è¿”å›**: Standard Output (æˆªæ–­å‰ 1000 å­—ç¬¦) + Standard Errorã€‚

#### **Tool 2: `tool_sys_monitor` (æ ‡å‡†åŒ–ç›‘æ§)**
*   **è®¾è®¡é€»è¾‘**:
    *   ç›´æ¥è°ƒç”¨ Python `psutil` åº“ã€‚
    *   `psutil.cpu_percent(interval=1)`
    *   `psutil.virtual_memory()`
    *   `psutil.disk_usage('/')`
*   **è¿”å›**: JSON å­—ç¬¦ä¸² `{"cpu": 15.0, "ram_used": "8GB", "ram_total": "16GB"}`ã€‚
*   **ç›®çš„**: ç»™ LLM æä¾›ç»“æ„åŒ–æ•°æ®ï¼Œè€Œä¸æ˜¯ `top` å‘½ä»¤é‚£ç§éš¾ä»¥è§£æçš„ä¹±ç ã€‚

#### **Tool 3: `tool_rag_query` (ç®€æ˜“å‘é‡æ£€ç´¢)**
*   **å‰ç½®æ¡ä»¶**: ç”¨æˆ· `/upload` æ–‡ä»¶æ—¶ï¼ŒServer ç«¯ä¸ä»…ä¿å­˜æ–‡ä»¶ï¼Œè¿˜éœ€è®¡ç®— Embedding å¹¶å­˜å…¥å†…å­˜åˆ—è¡¨ `VECTOR_DB`ã€‚
*   **è®¾è®¡é€»è¾‘**:
    1.  è°ƒç”¨ `embedding-3-pro` å°†ç”¨æˆ·çš„ `query` è½¬ä¸ºå‘é‡ `V_q`ã€‚
    2.  éå† `VECTOR_DB`ï¼Œè®¡ç®— `V_q` ä¸æ‰€æœ‰æ–‡æ¡£å—å‘é‡ `V_d` çš„**ä½™å¼¦ç›¸ä¼¼åº¦**ã€‚
    3.  æ’åºï¼Œå– Top 3 çš„æ–‡æœ¬å—ã€‚
*   **è¿”å›**: æ‹¼æ¥åçš„æ–‡æœ¬å—å­—ç¬¦ä¸²ã€‚

#### **Tool 4: `tool_file_download` (åè®®åˆ‡æ¢)**
*   **è®¾è®¡é€»è¾‘**:
    1.  éªŒè¯ `filepath` æ˜¯å¦å­˜åœ¨ä¸”åœ¨å…è®¸ç›®å½• (`uploads/`, `logs/`)ã€‚
    2.  ä¸ºè¯¥æ–‡ä»¶åˆ†é…ä¸€ä¸ª `download_token`ã€‚
    3.  åœ¨ L1 å±‚æ³¨å†Œä¸€ä¸ª UDP å¯¹ç«¯é¢„æœŸ (Expectation): `Expected Client IP = TCPè¿æ¥çš„IP`ã€‚
    4.  **ä¸ç›´æ¥è¿”å›æ–‡ä»¶å†…å®¹ç»™ LLM**ã€‚è€Œæ˜¯æ„é€ ä¸€ä¸ªç‰¹æ®Šçš„è¿”å›å€¼ `{"status": "offer_sent"}`ã€‚
    5.  **Side Effect**: ç«‹å³é€šè¿‡ NPLT é€šé“å‘é€ `DOWNLOAD_OFFER` (Type 0x0C) ç»™å®¢æˆ·ç«¯ã€‚

---

## 4. åè®®å­—æ®µé€ŸæŸ¥

### 4.1 NPLT (TCP)
Header: `[Type:1] [Seq:2] [Len:1]` (Len Max=255)

*   `AGENT_THOUGHT (0x0A)` Body Schema:
    ```json
    {
      "tool_name": "exec_cmd",
      "status": "start", 
      "desc": "Executing `ls -l`..."
    }
    ```
*   `DOWNLOAD_OFFER (0x0C)` Body Schema:
    ```json
    {
      "filename": "error.log",
      "filesize": 2560000,
      "udp_port": 9999,
      "token": "a1b2c3d4"
    }
    ```

### 4.2 RDT (UDP)
Header: `[Seq:2] [Check:2]`
Data: Max 1024 Bytes

*   **Server (Sender)** çŠ¶æ€æœº:
    *   `SendBase`: æœ€æ—©æœªç¡®è®¤çš„åŒ…åºå·ã€‚
    *   `NextSeqNum`: ä¸‹ä¸€ä¸ªå¾…å‘é€åºå·ã€‚
    *   `Window`: `[SendBase, SendBase + 4]`ã€‚
    *   **Timer**: ä»…å¯¹ `SendBase` è®¡æ—¶ã€‚è¶…æ—¶é‡ä¼  `SendBase` åˆ° `NextSeqNum-1`ã€‚

*   **Client (Receiver)** çŠ¶æ€æœº:
    *   `ExpectedSeqNum`: æœŸæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªåºå·ã€‚
    *   è‹¥æ”¶åˆ°åŒ… Seq == Expected: å†™å…¥æ–‡ä»¶ï¼Œå‘é€ `ACK(Expected)`ï¼Œ`Expected++`ã€‚
    *   è‹¥æ”¶åˆ°åŒ… Seq != Expected: ä¸¢å¼ƒï¼Œé‡å‘ `ACK(Expected-1)`ã€‚

---

